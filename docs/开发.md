# CAPEv2 二次开发作战手册

> 目标：让二开同学在 15 分钟内掌握 CAPEv2（Config And Payload Extraction）仓库的结构、运行姿势与扩展方式，后续直接查阅本文即可落地开发。

## 1. 定位与组成

- **Host 调度面**：`cuckoo.py`/`cape.service` 负责调度任务、调用虚拟化后端，并驱动 `ResultServer`、`rooter` 等守护进程。参见 `docs/book/src/usage/internals.rst` 对四大核心组件的拆解。
- **Guest 采集面**：`agent/agent.py` 运行在样本虚机内，x86 Python 解释器配合 `capemon`（独立仓库）负责 API hook、抓取内存/网络产物。
- **分析与流水线**：所有产物进入 `modules/processing` → `modules/signatures` → `modules/reporting` 三段式流水，由 `lib/cuckoo/core/plugins.py` 串联全局容器 `results`。
- **管理与可视化**：`web/` 为 Django 4.2 项目，内含 `analysis、submission、dashboard、users、apiv2` 等 app；`web/web/settings.py` 会按 `conf/web.conf`、`conf/reporting.conf` 初始化 Mongo/Elastic 连接。
- **扩展生态**：`custom/`（私有 Yara、解析器、签名）、`modules/machinery`（虚拟化接入）、`installer/`（部署脚本）、`systemd/` & `uwsgi/`（运维模板）构成二次开发主要落脚点。

## 2. 目录地图

| 目录 | 作用 | 关键文件 |
| --- | --- | --- |
| `analyzer/` | Guest 端分析器（Windows/Linux）及 `packages` | `analyzer/windows/packages/exe.py` |
| `agent/` | 客户端控制服务与单测 | `agent/agent.py`、`agent/test_agent.py` |
| `conf/` | 配置模板，`*.conf.default` + `*.conf`/`.conf.d` + `custom/conf`，详见 `conf/readme.md` | `conf/default/cuckoo.conf.default`、`conf/default/web.conf.default` |
| `docs/book/src` | 官方 Sphinx 文档；`customization/`、`usage/`、`installation/` 等章节可直接引用 | `docs/book/src/customization/*.rst` |
| `installer/` | 安装脚本（`cape2.sh`、`kvm-qemu.sh`、`suricata_from_source.sh` 等） | `installer/README.md` |
| `lib/cuckoo/` | 核心框架：抽象类、配置、数据库、插件管线 | `lib/cuckoo/common/abstracts.py`、`lib/cuckoo/core` |
| `modules/` | 扩展模块（`auxiliary、machinery、processing、signatures、reporting、feeds`） | `modules/processing/analysisinfo.py` 等 |
| `tests/` | Pytest 测试矩阵，含 `agent/`、`web/`、`modules/` 多套样例 | `tests/test_processing.py`、`tests/test_signature.py` |
| `utils/` | 调度配套脚本（`process.py`、`rooter.py`、`submit.py`、`dist.py`、`route.py` 等） | `utils/process.py`、`utils/rooter.py` |
| `web/` | Django 项目（`manage.py`、各 app、静态资源） | `web/web/settings.py`、`web/apiv2/views.py` |

## 3. 环境与基线

1. **操作系统 & 虚拟化**：官方推荐 Ubuntu 24.04 LTS + KVM/Libvirt（`README.md` 与 `installer/kvm-qemu.sh`）；也可切换 VMware、VirtualBox、Proxmox、AWS/Azure/vSphere 等，对应模块位于 `modules/machinery/`，配置模板见 `conf/default/*.conf.default`。
2. **Python & 依赖**：主机端 `python>=3.10,<4`（`pyproject.toml`）。统一使用 Poetry (`requires-poetry>=2.0`)：  
   ```bash
   curl -sSL https://install.python-poetry.org | python3 -
   poetry install --sync
   ```
3. **最小运行用户**：除 `rooter` 外均以 `cape` 用户运行，典型命令：`sudo -u cape poetry run python3 cuckoo.py`（`docs/book/src/usage/start.rst`）。
4. **配置目录**：遵循 `conf/readme.md` 约定，勿直接改 `*.conf.default`；可选 `conf/*.conf`、`conf/*.conf.d/`、`custom/conf/`；通过 `CAPE_CD=/path/to/conf poetry run ...` 切换外部配置集。
5. **数据库/缓存**：默认 SQLite（仅开发），生产使用 PostgreSQL + MongoDB 或 Elasticsearch（在 `conf/default/reporting.conf.default` 配置 `mongodb`/`elasticsearchdb`，`web/web/settings.py` 会校验至少启用其一）。

## 4. 运行与调试流程

| 流程 | 命令/位置 | 说明 |
| --- | --- | --- |
| 主调度 | `poetry run python3 cuckoo.py [-d]` | 启动 scheduler、加载 `machinery`、侦听任务队列。 |
| Web UI/API | `poetry run python manage.py runserver 0.0.0.0:8000` 或部署 `systemd/cape-web.service`、`uwsgi/cape.ini` | 若 `web.conf` 中启用 `web_reporting` 则依赖 Mongo/Elastic。 |
| 数据处理 | `poetry run python utils/process.py -p7 auto` | 可选 `--report`、`--signatures`、`--maxtasksperchild` 等参数（`docs/book/src/usage/start.rst`）。 |
| Rooter/Routing | `poetry run python utils/rooter.py` 搭配 `conf/routing.conf`、`conf/auxiliary.conf` 的 `dirtyline`/VPN 配置。 |
| 任务提交 | `poetry run python utils/submit.py --file sample.exe --timeout 300` 或 Web/API (`web/apiv2/`). |
| 日志排障 | `/opt/CAPEv2/log/cuckoo.log`、`journalctl -u virtqemud`（`docs/book/src/installation/guest/troubleshooting.rst`）。 |

## 5. 配置策略

- `conf/default/cuckoo.conf.default`：调度/任务参数（Machinery 选择、ResultServer、超时、存储阈值等）。
- `conf/default/processing.conf.default`、`reporting.conf.default`、`auxiliary.conf.default`：分别启停模块、配置路径（如 `tcpdump`、Volatility、VirusTotal API）。
- `conf/default/web.conf.default`：Web/REST 配置（YARA 预扫描、附件大小、OAuth/2FA、Guacamole 桌面、ZIP 下载、公共/匿名策略）。
- `conf/default/kvm.conf.default` 等 Machinery 配置：管理虚机标签、快照、静态 IP、接口、ResultServer 定制。
- 通过 `*.conf.d/*.conf` 拆分环境差异，也可把自研模块专属配置放到 `custom/conf/<module>.conf`。

## 6. 扩展点速查

### 6.1 Machinery（虚拟化/云资源）
- 路径：`modules/machinery/`；基类：`lib/cuckoo/common/abstracts.py` → `Machinery`/`LibVirtMachinery`。
- 必需方法：`start(label)`、`stop(label)`，异常统一抛出 `CuckooMachineError`。
- 配置：新增 `<name>.conf`（`conf/default/<name>.conf.default` 为模板），`[<name>] machines=a,b` + 每台虚机节定义 `label/platform/ip/interface/resultserver_*`。

### 6.2 Auxiliary（辅助模块）
- 路径：`modules/auxiliary/`；基类 `Auxiliary`；需实现 `start()`/`stop()`。
- 场景：流量抓取(`sniffer.py`)、VPN 切换等。可在 `data/auxiliary/<module>.py` 中编写 `configure(aux_instance)` 实现私有配置（`docs/book/src/customization/auxiliary.rst`）。

### 6.3 Analysis Packages（Guest 执行脚本）
- 路径：`analyzer/<platform>/packages/`；基类 `lib.common.abstracts.Package`。
- 核心方法：`start(path)`、`check()`、`finish()`，可复用 `self.execute()`、`Process()` API（`docs/book/src/customization/packages.rst`）。`self.options` 暴露提交参数，`PATHS`/`configure()` 可完成宿主应用准备。
- 私有包配置可放 `data/packages/<name>.py`（示例：禁用 ASLR）。

### 6.4 Processing 模块
- 路径：`modules/processing/`；基类 `Processing`；必需 `self.key` + `run()`。
- 配置：`conf/processing.conf` 控制启停。模块在 `self.analysis_path`、`self.pcap_path` 等属性上读取原始数据，并向全局 `results` 塞入结构化输出。可设置 `order` 控制执行顺序。详见 `docs/book/src/customization/processing.rst`。

### 6.5 Signatures
- 路径：`modules/signatures/`（按平台分类）；基类 `Signature`；核心属性 `name/description/severity/categories/families/minimum/...` 与 `run()`。
- 可使用 `check_file/check_mutex/check_api_call` 等 helper，或直接遍历 `self.results["behavior"]["summary"]`。事件化签名可覆盖 `on_call()`。
- 社区签名位于 https://github.com/CAPESandbox/community ，自研签名建议同步至 `custom/signatures/` 便于升级。

### 6.6 Reporting
- 路径：`modules/reporting/`；基类 `Report`；`run(results)` 中读取 `self.reports_path` 写文件或推送外部系统。
- 配置：`conf/reporting.conf`，典型模块包括 JSON dump、Mongo、Elasticsearch、HTML、Moloch/Arkime 等（参见 `docs/book/src/customization/reporting.rst`）。

### 6.7 Web / API / 前端
- Django App 布局：`web/analysis`（任务详情 & 报表）、`web/submission`（表单）、`web/dashboard`、`web/users`、`web/apiv2`（DRF 风格 API）等。
- 新增 API：在 `web/apiv2/urls.py` 注册路由，在 `views.py` 使用 Django/DRF 视图；若需鉴权规则，更新 `web/apiv2/throttling.py` 或 `web/users`。
- 前端模板位于 `web/templates/`，静态资源 `web/static`，如需扩展 Chart/表格请同步更新 `webpack`/`npm` 产物（若使用）。

### 6.8 数据、情报与脚本
- `data/yara/`、`custom/yara/`：YARA 规则（含内存与文件索引 `index_memory.yar`，处理模块 `Procmemory` 支持自定义规则）。
- `custom/parsers`：配置提取器，与 `CAPE-parsers` PyPI 包协作。
- `modules/feeds/`、`dev_utils/*.py`：对接外部情报源或本地调试脚本。
- `KnowledgeBaseBot/`：本地知识库/FAQ，可用于 ChatOps，若要更新需重建 `all_texts.json` 与 `unified_index.faiss`。

## 7. 质量控制与交付

- **编码规范**：遵循 `docs/book/src/development/code_style.rst`（PEP8/PEP257、132 列、双引号、`logging.getLogger(__name__)`）。所有源码头部保留版权注释。
- **静态检查**：`poetry run ruff check`、`poetry run ruff format --check`、`poetry run black --check`、`poetry run mypy agent`（`pyproject.toml` 已配置）。
- **单元测试**：`poetry run pytest`（`tests/` 与 `agent/tests`），仓库要求覆盖率 ≥90%，修 bug 时同步新增 case。
- **安全/依赖**：默认关闭外部 CI/CD，需手动运行 `poetry check`、`pip-audit`（可自行补充）并跟踪 `requirements.txt`/`poetry.lock`。
- **发布链路**：产出需附回滚方案与脚本（参见根 AGENTS.md 要求）， 推送功能同时更新 `docs/` 或本手册，保持可审计。

## 8. 常见二开场景提示

1. **新增任务类型**：综合 `modules/packages`（执行流程）、`conf/processing.conf`（处理链）、`modules/signatures`（识别逻辑）、`modules/reporting`（落地方式）；必要时在 `web/submission` 添加 UI。
2. **扩展虚拟化或云资源**：按 6.1 创建 Machinery + `conf/<mach>.conf`，同时在 `conf/cuckoo.conf` 设置 `machinery=<mach>`；若需弹性扩容参考 `conf/default/aws.conf.default` / `azure.conf.default`。
3. **接入情报/外部系统**：优先复用 `modules/reporting`/`modules/processing` hook；若需在线查询，可在 `utils/process.py` 自定义 `Processing` 插件以免阻塞主 Scheduler。
4. **排查虚机/网络问题**：首先检查 `/opt/CAPEv2/log/cuckoo.log` 与 `journalctl -u virtqemud`（`docs/book/src/installation/guest/troubleshooting.rst`），再确认 `conf/routing.conf` 中 `dirtyline` 指向物理出口、`agent.py` 运行权限、虚机静态 IP 配置无误。
5. **配置多环境**：使用 `CAPE_CD` + `.conf.d` 结构隔离（`conf/readme.md`），或在 `custom/` 下维护特定客户的 parsers/Yara/配置。

## 9. 参考 & 下一步

- `README.md`：总体介绍、依赖建议、历史背景。
- `docs/book/src/installation/*`：安装、KVM/VirtualBox/云环境脚本。
- `docs/book/src/usage/*`：调度、提交、API、集群、rooter、性能调优。
- `docs/book/src/customization/*`：各类模块编写细节。
- `systemd/*.service`、`uwsgi/*.ini`：生产部署模板，可按需复制。
- https://capev2.readthedocs.io/en/latest/ 与 https://github.com/CAPESandbox/community ：获取官方/社区更新。

> 建议：提交代码前回到本手册逐条自查（环境、配置、扩展点、测试、交付留痕），确保符合 “强制优先、结果导向、可审计” 的仓库治理要求。

## 10. 本地快速验证手册

面向想要在单机验证 Web 登录与基础提交流程的最小步骤：

1. **创建虚拟环境并安装依赖**
   ```bash
   cd /opt/CAPEv2
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt  # 或 poetry install
   ```
   `pip` 输出中带 `OPTIONAL! Missed dependency ...` 的项目（如 `httpreplay`、`regex`、`flare-floss`）可按需安装，不影响登录验证。

2. **初始化 Django 数据库**
   - CAPE 默认禁止 root 运行，若临时使用 root 仅用于测试，请在命令前添加 `CAPE_AS_ROOT=1`，或切换到 `cape` 用户：  
     `sudo -u cape -H bash -lc 'cd /opt/CAPEv2 && source .venv/bin/activate && python web/manage.py migrate'`
   - 首次执行 `python web/manage.py migrate` 会创建 SQLite 的 `auth_user`、`sessions` 等表；仓库已将数据库路径固定到 `<CAPE_ROOT>/siteauth.sqlite`，避免 runserver/migrate 指向不同目录。

3. **创建超级用户**
   ```bash
   CAPE_AS_ROOT=1 python web/manage.py createsuperuser
   ```
   若出现 `DuplicateOptionError: ENV:https_proxy`，说明环境变量中存在大小写不同的代理条目，先执行 `unset https_proxy HTTPS_PROXY http_proxy HTTP_PROXY` 再重试。

4. **启动 Web（开发模式）**
   ```bash
   CAPE_AS_ROOT=1 python web/manage.py runserver 0.0.0.0:8000
   ```
   浏览器访问 `http://<host>:8000/` 会跳转到 `/login/`，输入刚创建的账号即可进入 dashboard。需要常驻部署时改用 `systemd/cape-web.service` 或 `uwsgi/cape.ini`。

5. **常见问题速查**
   - `Root is not allowed`：未设置 `CAPE_AS_ROOT=1` 或未切换到 `cape` 用户。
   - `no such table: auth_user`：尚未执行迁移或数据库被清空，回到步骤 2。
   - 缺少 `pytest/sqlalchemy`：本仓库未内置开发依赖，按需 `pip install pytest sqlalchemy`，即可运行 `python -m pytest tests/web/test_auth_views.py` 验证登录守卫逻辑。

按以上流程即可完成“新环境 → 初始化数据库 → 创建用户 → 启动 Web → 验证登录”全链路，方便复现和文档化本地测试。
