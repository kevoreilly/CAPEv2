{% load key_tags %}
<div class="card bg-dark border-secondary mb-3">
    <div class="card-header border-secondary">
        <h5 class="mb-0 text-white"><i class="fas fa-file mr-2 text-primary"></i> File Information</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-dark table-striped table-bordered mb-0" style="table-layout: fixed;">
            {% if source_url %}
            <tr>
                <th style="width: 20%;">Downloaded From</th>
                <td class="text-break">{{source_url|escape}}</td>
            </tr>
            {% endif %}

            {% if file.cape_type %}
            <tr>
                <th>Type</th>
                <td><strong>{{file.cape_type}}</strong></td>
            </tr>
            {% endif %}

            <tr>
                <th>Filename</th>
                <td class="text-break">
                    {% for name in file.name|str2list %}
                    <div><strong>{{name|safe}}</strong></div>
                    {% endfor %}
                </td>
            </tr>

            {% if file.type %}
            <tr>
                <th>File Type</th>
                <td>{{file.type}}</td>
            </tr>
            {% endif %}

            {% if file.guest_paths and tab_name == "dropped" %}
            <tr>
                <th>Associated Filenames</th>
                <td class="text-break">
                    {% for path in file.guest_paths|str2list %}
                        <div>{{path}}</div>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}

            <tr>
                <th>File Size</th>
                <td>{{file.size}} bytes</td>
            </tr>

            {% if file.module_path and file.process_path != file.module_path %}
            <tr>
                <th>Module Path</th>
                <td class="text-break">{{file.module_path}}</td>
            </tr>
            {% endif %}

            {% if file.cape_type_code == 8 or file.cape_type_code == 9 %}
                <tr>
                    <th>Virtual Address</th>
                    <td>{{file.virtual_address}}</td>
                </tr>
            {% endif %}
            {% if file.cape_type_code == 5 %}
                <tr>
                    <th>Section Handle</th>
                    <td>{{file.section_handle}}</td>
                </tr>
            {% endif %}
            {% if file.cape_type_code == 3 or file.cape_type_code == 4 %}
                <tr>
                    <th>Target Process</th>
                    <td>{{file.target_process}} (PID: {{file.target_pid}})</td>
                </tr>
                <tr>
                    <th>Target Path</th>
                    <td class="text-break">{{file.target_path}}</td>
                </tr>
                <tr>
                    <th>Injecting Process</th>
                    <td>{{file.process_name}} (PID: {{file.pid}})</td>
                </tr>
                <tr>
                    <th>Path</th>
                    <td class="text-break">{{file.process_path}}</td>
                </tr>
            {% else %}
                {% if file.process_name %}
                <tr>
                    <th>Process</th>
                    <td>{{file.process_name}} {% if file.pid %}(PID: {{file.pid}}){% endif %}</td>
                </tr>
                {% endif %}
                {% if file.process_path %}
                <tr>
                    <th>Path</th>
                    <td class="text-break">{{file.process_path}}</td>
                </tr>
                {% endif %}
            {% endif %}

            {% if file.timestamp %}
            <tr>
                <th>PE Timestamp</th>
                <td>{{file.timestamp}}</td>
            </tr>
            {% endif %}

            <tr>
                <th>MD5</th>
                <td class="text-monospace">{{file.md5}}</td>
            </tr>
            <tr>
                <th>SHA1</th>
                <td class="text-monospace">{{file.sha1}}</td>
            </tr>
            <tr>
                <th>SHA256</th>
                <td class="text-monospace">
                    {{file.sha256}}
                    <br>
                    <a href="https://www.virustotal.com/gui/file/{{file.sha256}}/" class="badge badge-danger" target="_blank">VT</a>
                    <a href="https://mwdb.cert.pl/file/{{file.sha256}}" class="badge badge-warning" target="_blank">MWDB</a>
                    <a href="https://bazaar.abuse.ch/sample/{{file.sha256}}/" class="badge badge-info" target="_blank">Bazaar</a>
                </td>
            </tr>

            {% if file.sha3_384 %}
            <tr>
                <th>SHA3-384</th>
                <td class="text-monospace text-break">{{file.sha3_384}}</td>
            </tr>
            {% endif %}
            {% if file.rh_hash %}
            <tr>
                <th>RichHeader Hash</th>
                <td class="text-monospace">{{file.rh_hash}}</td>
            </tr>
            {% endif %}
            <tr>
                <th>CRC32</th>
                <td class="text-monospace">{{file.crc32}}</td>
            </tr>
            {% if file.tlsh %}
            <tr>
                <th>TLSH</th>
                <td class="text-monospace text-break">{{file.tlsh}}</td>
            </tr>
            {% endif %}
            <tr>
                <th>Ssdeep</th>
                <td class="text-monospace text-break">{{file.ssdeep}}</td>
            </tr>

            {% if file.clamav %}
            <tr>
                <th>ClamAV</th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in file.clamav %}
                        <li><span class="badge badge-danger">{{sign}}</span></li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if file.yara %}
            <tr>
                <th>Yara</th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in file.yara %}
                        <li>
                            <span class="text-warning font-weight-bold">{{sign.name}}</span> - {{sign.meta.description}}
                            {% if sign.meta.author %} <small class="text-muted">({{sign.meta.author}})</small>{% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if file.cape_yara %}
            <tr>
                <th>CAPE Yara</th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in file.cape_yara %}
                        <li>
                            <span class="text-info font-weight-bold">{{sign.name}}</span>
                            {% if sign.meta.cape_type %} <span class="badge badge-secondary">{{sign.meta.cape_type}}</span>{% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if file.trid %}
            <tr>
                <th>TriD</th>
                <td>
                    <ul class="list-unstyled mb-0">
                        {% for str in file.trid %}<li>{{str}}</li>{% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if file.die %}
            <tr>
                <th>Detect It Easy</th>
                <td>
                    <ul class="list-unstyled mb-0">
                        {% for str in file.die %}<li>{{str}}</li>{% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}
        </table>
    </div>

    {% if not file.dropdir %}
        <!-- Expanded Details (Collapsible) -->
        <div class="card-footer bg-dark border-secondary">
            {% if file.pe %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('pe_{{file.sha256}}');">PE Info</button>
                <div id="pe_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_pe.html" %}
                </div>
            {% endif %}

            {% if file.dotnet %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('dotnet_{{file.sha256}}');">.NET Info</button>
                <div id="dotnet_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_dotnet.html" %}
                </div>
            {% endif %}

            {% if file.pdf %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('pdf_{{file.sha256}}');">PDF Info</button>
                <div id="pdf_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_pdf.html" %}
                </div>
            {% endif %}

            {% if file.lnk %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('lnk_{{file.sha256}}');">LNK Info</button>
                <div id="lnk_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_lnk.html" %}
                </div>
            {% endif %}

            {% if file.java %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('java_{{file.sha256}}');">Java Info</button>
                <div id="java_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_java.html" %}
                </div>
            {% endif %}

            {% if file.office %}
                <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('office_{{file.sha256}}');">Office Info</button>
                <div id="office_{{file.sha256}}" style="display: none;" class="mt-2">
                    {% include "generic/_office.html" %}
                </div>


                {% if file.office.XLMMacroDeobfuscator %}
                    <button class="btn btn-sm btn-outline-info mb-2" type="button" onclick="showHide('xlmmacro_{{file.sha256}}');">XLM Macro</button>
                    <div id="xlmmacro_{{file.sha256}}" style="display: none;" class="mt-2">
                        {% include "generic/_xlmmacro.html" %}
                    </div>
                {% endif %}

            {% endif %}
            {% if file.flare_capa %}
                <button class="btn btn-sm btn-outline-warning mb-2" type="button" onclick="showHide('flare_capa_{{file.sha256}}');">FLARE CAPA</button>
                <div id="flare_capa_{{file.sha256}}" style="display: none;" class="mt-2">
                    <div class="card card-body bg-secondary text-white">
                        {% if file.flare_capa.CAPABILITY %}{{file.flare_capa|flare_capa_capability}}{% endif %}
                        {% if file.flare_capa.ATTCK %}{{file.flare_capa|flare_capa_attck}}{% endif %}
                        {% if file.flare_capa.MBC %}{{file.flare_capa|flare_capa_mbc}}{% endif %}
                    </div>
                </div>
            {% endif %}

            {% if file.strings %}
                <button class="btn btn-sm btn-outline-light mb-2" type="button" onclick="showHide('strings_{{file.sha256}}');">Strings</button>
                <div id="strings_{{file.sha256}}" style="display: none;" class="mt-2">
                    <div class="card card-body bg-secondary text-white" style="max-height: 300px; overflow-y: auto;">
                        <pre class="mb-0 text-light">{% for string in file.strings %}{{string}}<br>{% endfor %}</pre>
                    </div>
                </div>
            {% endif %}

            {% if file.virustotal %}
                <div class="mt-3">
                    {% include "generic/_virustotal.html" %}
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>