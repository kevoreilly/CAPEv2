<!-- Identical copy of _file_info.html adapted for sub_file -->
{% load key_tags %}

<div class="card bg-dark border-secondary mb-3">
    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-white"><i class="fas fa-file-invoice me-2 text-info"></i> Subfile Information</h5>
        {% if sub_file.dropdir %}
            <a href="{% url "file" tab_name id sub_file.dropdir %}" class="btn btn-sm btn-outline-light"><i class="fas fa-download"></i> Download</a>
        {% else %}
            <div class="btn-group btn-group-sm">
                {% if not config.zipped_download %}
                    {% if tab_name == "static" %}
                        <a href="{% url "file" "dropped" id sub_file.sha256 %}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Download"><i class="fas fa-download"></i></a>
                    {% else %}
                        <a href="{% url "file" tab_name id sub_file.sha256 %}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Download"><i class="fas fa-download"></i></a>
                    {% endif %}
                {% endif %}
                {% if tab_name == "static" %}
                     <a href="{% url "file" "droppedzip" id sub_file.sha256 %}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Download Archive"><i class="fas fa-file-archive"></i></a>
                {% else %}
                    <a href="{% url "file" tab_name|add:"zip" id sub_file.sha256 %}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Download Archive"><i class="fas fa-file-archive"></i></a>
                {% endif %}
                <a href="/submit/resubmit/{{id}}/{{sub_file.sha256}}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Resubmit"><i class="fas fa-sync"></i></a>
                {% if config.vtupload and analysis.info.tlp != "Red" %}
                    <a href="{% url "vtupload" tab_name id sub_file.name sub_file.sha256 %}" class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Upload to VirusTotal"><i class="fas fa-cloud-upload-alt"></i> VT</a>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-striped mb-0" style="table-layout: fixed;">
            {% if sub_file.note %}
            <tr>
                <th style="width: 15%;">Note</th>
                <td class="text-break"><strong>{{sub_file.note}}</strong></td>
            </tr>
            {% endif %}

            {% if sub_file.cape_type %}
            <tr>
                <th style="width: 15%;">Type</th>
                <td><strong>{{sub_file.cape_type}}</strong></td>
            </tr>
            {% endif %}

            <tr>
                <th style="width: 15%;">Filename</th>
                <td class="text-break">
                    {% for name in sub_file.name|str2list %}
                    <div><strong>{{name|safe}}</strong></div>
                    {% endfor %}
                </td>
            </tr>

            {% if sub_file.type %}
            <tr>
                <th style="width: 15%;">File Type</th>
                <td>{{sub_file.type}}</td>
            </tr>
            {% endif %}

            {% if sub_file.guest_paths %}
            <tr>
                <th style="width: 15%;">Associated Filenames</th>
                <td class="text-break">
                    {% for path in sub_file.guest_paths|str2list %}
                        <div>{{path}}</div>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}

            <tr>
                <th style="width: 15%;">File Size</th>
                <td>{{sub_file.size}} bytes</td>
            </tr>

            {% if sub_file.module_path and sub_file.process_path != sub_file.module_path %}
            <tr>
                <th style="width: 15%;">Module Path</th>
                <td class="text-break">{{sub_file.module_path}}</td>
            </tr>
            {% endif %}

            {% if sub_file.cape_type_code == 8 or sub_file.cape_type_code == 9 %}
                <tr>
                    <th style="width: 15%;">Virtual Address</th>
                    <td>{{sub_file.virtual_address}}</td>
                </tr>
            {% endif %}
            {% if sub_file.cape_type_code == 5 %}
                <tr>
                    <th style="width: 15%;">Section Handle</th>
                    <td>{{sub_file.section_handle}}</td>
                </tr>
            {% endif %}
            {% if sub_file.cape_type_code == 3 or sub_file.cape_type_code == 4 %}
                <tr>
                    <th style="width: 15%;">Target Process</th>
                    <td>{{sub_file.target_process}} (PID: {{sub_file.target_pid}})</td>
                </tr>
                <tr>
                    <th style="width: 15%;">Target Path</th>
                    <td class="text-break">{{sub_file.target_path}}</td>
                </tr>
                <tr>
                    <th style="width: 15%;">Injecting Process</th>
                    <td>{{sub_file.process_name}} (PID: {{sub_file.pid}})</td>
                </tr>
                <tr>
                    <th style="width: 15%;">Path</th>
                    <td class="text-break">{{sub_file.process_path}}</td>
                </tr>
            {% else %}
                {% if sub_file.process_name %}
                <tr>
                    <th style="width: 15%;">Process</th>
                    <td>{{sub_file.process_name}} {% if sub_file.pid %}(PID: {{sub_file.pid}}){% endif %}</td>
                </tr>
                {% endif %}
                {% if sub_file.process_path %}
                <tr>
                    <th style="width: 15%;">Path</th>
                    <td class="text-break">{{sub_file.process_path}}</td>
                </tr>
                {% endif %}
            {% endif %}

            <tr>
                <th style="width: 15%;">MD5</th>
                <td class="text-monospace">{{sub_file.md5}}</td>
            </tr>
            <tr>
                <th style="width: 15%;">SHA1</th>
                <td class="text-monospace">{{sub_file.sha1}}</td>
            </tr>
            <tr>
                <th style="width: 15%;">SHA256</th>
                <td class="text-monospace">
                    {{sub_file.sha256}}
                    <span class="ms-2">
                        <a href="https://www.virustotal.com/gui/file/{{sub_file.sha256}}/" class="badge bg-danger" target="_blank">VT</a>
                        <a href="https://mwdb.cert.pl/file/{{sub_file.sha256}}" class="badge bg-warning" target="_blank">MWDB</a>
                        <a href="https://bazaar.abuse.ch/sample/{{sub_file.sha256}}/" class="badge bg-info" target="_blank">Bazaar</a>
                    </span>
                </td>
            </tr>
            {% if sub_file.sha3_384 %}
            <tr>
                <th style="width: 15%;">SHA3-384</th>
                <td class="text-monospace text-break">{{sub_file.sha3_384}}</td>
            </tr>
            {% endif %}
            {% if sub_file.rh_hash %}
            <tr>
                <th style="width: 15%;">RichHeader Hash</th>
                <td class="text-monospace">{{sub_file.rh_hash}}</td>
            </tr>
            {% endif %}
            <tr>
                <th style="width: 15%;">CRC32</th>
                <td class="text-monospace">{{sub_file.crc32}}</td>
            </tr>
            {% if sub_file.tlsh %}
            <tr>
                <th style="width: 15%;">TLSH</th>
                <td class="text-monospace text-break">{{sub_file.tlsh}}</td>
            </tr>
            {% endif %}
            <tr>
                <th style="width: 15%;">Ssdeep</th>
                <td class="text-monospace text-break">{{sub_file.ssdeep}}</td>
            </tr>

            {% if sub_file.clamav %}
            <tr>
                <th style="width: 15%;">ClamAV</th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in sub_file.clamav %}
                        <li><span class="badge bg-danger">{{sign}}</span></li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if sub_file.yara %}
            <tr>
                <th style="width: 15%;">
                    {% if config.yara_detail %}
                        <a class="btn btn-sm btn-outline-light" data-bs-toggle="collapse" href="#yara_{{sub_file.sha256}}" role="button"><i class="fas fa-file-code"></i> Yara</a>
                    {% else %}
                        Yara
                    {% endif %}
                </th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in sub_file.yara %}
                        <li>
                            <a href="/analysis/search/yaraname:{{sign.name}}" class="text-warning font-weight-bold">{{sign.name}}</a>
                            <span class="text-muted">- {{sign.meta.description}}</span>
                            {% if sign.meta.author %} <small class="text-muted">({{sign.meta.author}})</small>{% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if sub_file.cape_yara %}
            <tr>
                <th style="width: 15%;">
                    {% if config.yara_detail %}
                        <a class="btn btn-sm btn-outline-light" data-bs-toggle="collapse" href="#capeyara_{{sub_file.sha256}}" role="button"><i class="fas fa-file-signature"></i> CAPE Yara</a>
                    {% else %}
                        CAPE Yara
                    {% endif %}
                </th>
                <td>
                    <ul class="list-unstyled mb-0">
                    {% for sign in sub_file.cape_yara %}
                        <li>
                            <a href="/analysis/search/capeyara:{{sign.name}}" class="text-info font-weight-bold">{{sign.name}}</a>
                            {% if sign.meta.cape_type %} <span class="badge bg-secondary">{{sign.meta.cape_type}}</span>{% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if sub_file.trid %}
            <tr>
                <th style="width: 15%;">TriD</th>
                <td>
                    <ul class="list-unstyled mb-0">
                        {% for str in sub_file.trid %}<li>{{str}}</li>{% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}

            {% if sub_file.die %}
            <tr>
                <th style="width: 15%;">Detect It Easy</th>
                <td>
                    <ul class="list-unstyled mb-0">
                        {% for str in sub_file.die %}<li>{{str}}</li>{% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}
        </table>
    </div>

    <!-- Tools & Actions -->
    {% if not sub_file.dropdir %}
    <div class="card-footer bg-dark border-secondary">
        <div class="d-flex flex-wrap justify-content-start align-items-center">
            <span class="me-3 text-muted mb-2">Tools:</span>
            
            {% if sub_file.pe %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#pe_{{sub_file.sha256}}">PE</a>{% endif %}
            {% if sub_file.dotnet %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#dotnet_{{sub_file.sha256}}">.NET</a>{% endif %}
            {% if sub_file.pdf %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#pdf_{{sub_file.sha256}}">PDF</a>{% endif %}
            {% if sub_file.lnk %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#lnk_{{sub_file.sha256}}">LNK</a>{% endif %}
            {% if sub_file.java %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#java_{{sub_file.sha256}}">Java</a>{% endif %}
            {% if sub_file.office %}<a class="btn btn-sm btn-outline-info me-2 mb-2" data-bs-toggle="collapse" href="#office_{{sub_file.sha256}}">Office</a>{% endif %}
            
            {% if config.flare_capa %}
                {% if not sub_file.flare_capa and on_demand.flare_capa %}
                    <a class="btn btn-sm btn-secondary me-2 mb-2" href="{% url "on_demand" "flare_capa" id tab_name sub_file.sha256 %}">Gen CAPA</a>
                {% elif sub_file.flare_capa %}
                    <a class="btn btn-sm btn-outline-warning me-2 mb-2" data-bs-toggle="collapse" href="#flare_capa_{{sub_file.sha256}}">View CAPA</a>
                {% endif %}
            {% endif %}

            {% if config.strings %}
                {% if "strings" not in sub_file %}
                    <a class="btn btn-sm btn-secondary me-2 mb-2" href="{% url "on_demand" "strings" id "static" sub_file.sha256 %}">Gen Strings</a>
                {% elif sub_file.strings %}
                    <a class="btn btn-sm btn-outline-light me-2 mb-2" data-bs-toggle="collapse" href="#strings_{{sub_file.sha256}}">Strings</a>
                {% endif %}
            {% endif %}

            {% if config.floss %}
                {% if not sub_file.floss %}
                    <a class="btn btn-sm btn-secondary me-2 mb-2" href="{% url "on_demand" "floss" id "static" sub_file.sha256 %}">Gen Floss</a>
                {% else %}
                    <a class="btn btn-sm btn-outline-light me-2 mb-2" data-bs-toggle="collapse" href="#floss_{{sub_file.sha256}}">Floss</a>
                {% endif %}
            {% endif %}

            {% if config.bingraph %}
                {% if not graphs.bingraph.content|getkey:sub_file.sha256 and on_demand.bingraph %}
                    <a class="btn btn-sm btn-secondary me-2 mb-2" href="{% url "on_demand" "bingraph" id tab_name sub_file.sha256 %}">Gen BinGraph</a>
                {% elif graphs.bingraph.content|getkey:sub_file.sha256 %}
                    <a class="btn btn-sm btn-outline-light me-2 mb-2" href="{% url "file_nl" "bingraph" id sub_file.sha256 %}">BinGraph</a>
                {% endif %}
            {% endif %}

            {% if sub_file.data %}
                <a class="btn btn-sm btn-outline-light me-2 mb-2" data-bs-toggle="collapse" href="#text_{{sub_file.sha256}}">Text</a>
            {% endif %}

            {% if sub_file.decoded_files %}
                <a class="btn btn-sm btn-outline-light me-2 mb-2" data-bs-toggle="collapse" href="#decoded_files_{{sub_file.sha256}}">{{sub_file.decoded_files_tool}}</a>
            {% endif %}

            {% if sub_file.extracted_files %}
                <a class="btn btn-sm btn-outline-light me-2 mb-2" data-bs-toggle="collapse" href="#extracted_files_{{sub_file.sha256}}">{{sub_file.extracted_files_tool}}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Collapsible Content -->
<div class="mb-4">
    {% if sub_file.flare_capa %}
        <div class="collapse mb-3" id="flare_capa_{{sub_file.sha256}}">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary"><h6 class="mb-0 text-white">CAPA Results</h6></div>
                <div class="card-body">
                    {% if file.flare_capa.CAPABILITY or file.flare_capa.ATTCK or file.flare_capa.MBC %}
                        {% if file.flare_capa.CAPABILITY %}{{ file.flare_capa|flare_capa_capability }}{% endif %}
                        {% if file.flare_capa.ATTCK %}{{ file.flare_capa|flare_capa_attck }}{% endif %}
                        {% if file.flare_capa.MBC %}{{ file.flare_capa|flare_capa_mbc }}{% endif %}
                    {% else %}
                        No significant results.
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if graphs.vba2graph.enabled and graphs.vba2graph.content|getkey:sub_file.sha256 %}
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-body text-center">{{ graphs.vba2graph.content|getkey:sub_file.sha256|safe }}</div>
        </div>
    {% endif %}

    {% if sub_file.virustotal %}
        <div class="mb-3">{% include "analysis/generic/_virustotal.html" %}</div>
    {% endif %}

    {% if sub_file.strings %}
        <div class="collapse mb-3" id="strings_{{sub_file.sha256}}">
            <div class="card bg-secondary text-white">
                <div class="card-header"><h6 class="mb-0">Strings</h6></div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {{sub_file.strings|safe}}
                </div>
            </div>
        </div>
    {% endif %}

    {% if sub_file.dotnet_strings %}
        <div class="collapse mb-3" id="dotnet_strings_{{file.sha256}}">
            <div class="card bg-secondary text-white">
                <div class="card-header"><h6 class="mb-0">.NET Strings</h6></div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for string in sub_file.dotnet_strings %}<div>{{string|safe}}</div>{% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if sub_file.data %}
        <div class="collapse mb-3" id="text_{{sub_file.sha256}}">
            <div class="card bg-secondary text-white">
                <div class="card-header"><h6 class="mb-0">Extracted Text</h6></div>
                <div class="card-body">
                    <pre class="mb-0 text-light small">{{sub_file.data|escape}}</pre>
                </div>
            </div>
        </div>
    {% endif %}

    {% if sub_file.decoded_files %}
        <div class="collapse mb-3" id="decoded_files_{{sub_file.sha256}}">
            <div class="card bg-secondary text-white">
                <div class="card-header"><h6 class="mb-0">Decoded File Content</h6></div>
                <div class="card-body">
                    <pre class="mb-0 text-light small">{{sub_file.decoded_files|escape}}</pre>
                </div>
            </div>
        </div>
    {% endif %}

    {% if sub_file.extracted_files %}
        <div class="collapse mb-3" id="extracted_files_{{sub_file.sha256}}">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary"><h6 class="mb-0 text-white">Extracted Files</h6></div>
                <div class="card-body">
                    {% for sub_file in sub_file.extracted_files %}
                        {% include "analysis/generic/_subfile_info.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if config.yara_detail and sub_file.yara %} <div class="collapse mb-3" id="yara_{{sub_file.sha256}}"> {% include "analysis/generic/_subfile_yara.html" %}</div>{% endif %}
    {% if config.yara_detail and sub_file.cape_yara %} <div class="collapse mb-3" id="capeyara_{{sub_file.sha256}}"> {% include "analysis/generic/_subfile_capeyara.html" %}</div>{% endif %}
    {% if sub_file.pe %} <div class="collapse mb-3" id="pe_{{sub_file.sha256}}"> {% include "analysis/generic/_pe.html" %}</div>{% endif %}
    {% if sub_file.dotnet %} <div class="collapse mb-3" id="dotnet_{{sub_file.sha256}}"> {% include "analysis/generic/_dotnet.html" %}</div>{% endif %}
    {% if sub_file.pdf %} <div class="collapse mb-3" id="pdf_{{sub_file.sha256}}"> {% include "analysis/generic/_pdf.html" %}</div>{% endif %}
    {% if sub_file.lnk %} <div class="collapse mb-3" id="lnk_{{sub_file.sha256}}"> {% include "analysis/generic/_lnk.html" %}</div>{% endif %}
    {% if sub_file.java %} <div class="collapse mb-3" id="java_{{sub_file.sha256}}"> {% include "analysis/generic/_java.html" %}</div>{% endif %}
    {% if sub_file.office %} <div class="collapse mb-3" id="office_{{sub_file.sha256}}"> {% include "analysis/generic/_office.html" %}</div>{% endif %}
    {% if sub_file.floss %} <div class="collapse mb-3" id="floss_{{sub_file.sha256}}"> {% include "analysis/generic/_floss.html" %}</div>{% endif %}

    {% if graphs.bingraph.enabled and graphs.bingraph.content|getkey:sub_file.sha256 %}
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-body text-center">{{ graphs.bingraph.content|getkey:sub_file.sha256|safe }}</div>
        </div>
    {% endif %}
</div>
