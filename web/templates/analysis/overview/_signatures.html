{% load analysis_tags %}

<section id="signatures" class="mb-4">
    <div class="card bg-dark border-secondary">
        <div class="card-header border-secondary">
            <h5 class="mb-0 text-white"><i class="fas fa-file-signature me-2 text-warning"></i> Signatures</h5>
        </div>
        <div class="card-body p-0">
            {% if analysis.signatures %}
                <div class="accordion" id="signaturesAccordion">
                {% for signature in analysis.signatures %}
                    <div class="card bg-dark border-bottom border-secondary rounded-0">
                        <div class="card-header p-0" id="headingSig{{forloop.counter}}">
                            <h2 class="mb-0">
                                <button class="btn btn-block text-start p-3 d-flex align-items-center justify-content-between text-decoration-none shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#signature_{{signature.name}}" aria-expanded="false" aria-controls="signature_{{signature.name}}">
                                    <span class="d-flex align-items-center text-white">
                                        {% if signature.severity <= 1 %}
                                            <i class="fas fa-info-circle text-info me-3 fa-lg"></i>
                                        {% elif signature.severity == 2 %}
                                            <i class="fas fa-exclamation-triangle text-warning me-3 fa-lg"></i>
                                        {% elif signature.severity >= 3 %}
                                            <i class="fas fa-biohazard text-danger me-3 fa-lg"></i>
                                        {% endif %}
                                        <span class="font-weight-bold">{{signature.description}}</span>
                                    </span>
                                    <i class="fas fa-chevron-down text-muted"></i>
                                </button>
                            </h2>
                        </div>

                        <div id="signature_{{signature.name}}" class="collapse" aria-labelledby="headingSig{{forloop.counter}}" data-bs-parent="#signaturesAccordion">
                            <div class="card-body bg-secondary text-white">
                                {% if signature.data %}
                                    <div class="mb-3">
                                    {% for sign in signature.data %}
                                        {% for key, value in sign.items %}
                                            <div class="mb-1"><strong class="text-light">{{key}}:</strong> {{value}}</div>
                                        {% endfor %}
                                    {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="table-responsive">
                                        <table class="table table-dark table-sm table-striped mb-0" style="table-layout: fixed;">
                                            <tbody>
                                                {% for match in signature.new_data %}
                                                    {% if match.process.process_name %}
                                                        <tr class="bg-info text-dark font-weight-bold"><td colspan="9">Process: {{match.process.process_name}} ({{match.process.process_id}})</td></tr>
                                                    {% endif %}
                                                    {% for sign in match.signs %}
                                                        <tr>
                                                            {% if sign.type == 'api' %}
                                                                {% include "analysis/behavior/_api_call.html" with call=sign.value %}
                                                                <td class="text-end">
                                                                    <a href='#' class='call-link btn btn-sm btn-outline-light' data-pid='{{match.process.process_id}}' data-cid='{{sign.value.id}}'>
                                                                        <i class="fas fa-arrow-circle-right"></i>
                                                                    </a>
                                                                </td>
                                                            {% else %}
                                                                <td colspan="2" class="text-muted text-uppercase small font-weight-bold">{{sign.type}}</td>
                                                                <td colspan="7">
                                                                    {% if sign.value|is_dict %}
                                                                        {% for key, value in  sign.value.items %}
                                                                            <span class='text-info font-weight-bold'>{{key}}:</span>
                                                                            <span>{{value}}</span><br />
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        {{sign.value}}
                                                                    {% endif %}
                                                                </td>
                                                            {% endif %}
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                                
                                {% if signature.calls %}
                                    <div id="signature-calls_{{signature.name}}" class="mt-3"></div>
                                    {% with data_id="signature-calls-data_"|add:signature.name %}
                                        {{ signature.calls | json_script:data_id }}
                                        <script type="text/javascript">
                                            $(document).ready(function(){
                                                $("#signature_{{signature.name}}").one("show.bs.collapse", function() {
                                                    $.ajax(
                                                        "{% url "signature-calls" task_id=analysis.info.id %}",
                                                        {
                                                            contentType: "application/json",
                                                            data: document.getElementById("{{data_id}}").textContent,
                                                            dataType: "html",
                                                            method: "POST",
                                                            success: function(responseText) {
                                                                $("#signature-calls_{{signature.name}}").html(responseText);
                                                            }
                                                        }
                                                    );
                                                });
                                            });
                                        </script>
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-0">No suspicious signatures detected.</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
