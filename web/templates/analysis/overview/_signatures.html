{% load analysis_tags %}

{% if analysis.signatures %}
<section id="signatures" class="mb-4">
    <div class="card border-secondary">
        <div class="card-header border-secondary">
            <h5 class="mb-0 text-white"><i class="fas fa-file-signature me-2 text-warning"></i> Signatures</h5>
        </div>
        <div class="card-body">
            {% if analysis.signatures %}
                                <div class="list-group">
                                {% for signature in analysis.signatures %}
                                    <div>
                    <a href="#signature_collapse_{{signature.name}}" class="list-group-item list-group-item-action py-1 text-dark
                        {% if signature.severity >= 3 %}list-group-item-danger{% elif signature.severity == 2 %}list-group-item-warning{% elif signature.severity == 1 %}list-group-item-success{% else %}list-group-item-info{% endif %}"
                        data-bs-toggle="collapse" aria-expanded="false" aria-controls="signature_collapse_{{signature.name}}">
                                        <div class="d-flex w-50 justify-content-between">
                                            <div class="mb-1 text-dark">
                                                {% if signature.severity <= 1 %}
                                                    <i class="fas fa-info-circle me-2 text-dark"></i>
                                                {% elif signature.severity == 2 %}
                                                    <i class="fas fa-exclamation-triangle me-2 text-dark"></i>
                                                {% elif signature.severity >= 3 %}
                                                    <i class="fas fa-biohazard me-2 text-dark"></i>
                                                {% endif %}
                                                {{signature.description}}
                                            </div>
                                            <small class="text-dark"><i class="fas fa-chevron-down"></i></small>
                                        </div>
                                    </a>
                                    <div class="collapse" id="signature_collapse_{{signature.name}}">
                                        <div class="card card-body text-white mt-1">
                                            {% if signature.data %}
                                                <div class="mb-3">
                                                {% for sign in signature.data %}
                                                    {% for key, value in sign.items %}
                                                        <div class="mb-1"><strong class="text-light">{{key}}:</strong> {{value}}</div>
                                                    {% endfor %}
                                                {% endfor %}
                                                </div>
                                            {% else %}
                                                <div class="table-responsive">
                                                    <table class="table table-dark table-sm table-striped mb-0" style="table-layout: fixed;">
                                                        <tbody>
                                                            {% for match in signature.new_data %}
                                                                {% if match.process.process_name %}
                                                                    <tr class="bg-info text-dark fw-bold"><td colspan="9">Process: {{match.process.process_name}} ({{match.process.process_id}})</td></tr>
                                                                {% endif %}
                                                                {% for sign in match.signs %}
                                                                    <tr>
                                                                        {% if sign.type == 'api' %}
                                                                            {% include "analysis/behavior/_api_call.html" with call=sign.value %}
                                                                            <td class="text-end">
                                                                                <a href='#' class='call-link btn btn-sm btn-outline-light' data-pid='{{match.process.process_id}}' data-cid='{{sign.value.id}}'>
                                                                                    <i class="fas fa-arrow-circle-right"></i>
                                                                                </a>
                                                                            </td>
                                                                        {% else %}
                                                                            <td colspan="2" class="text-white-50 text-uppercase small fw-bold">{{sign.type}}</td>
                                                                            <td colspan="7">
                                                                                {% if sign.value|is_dict %}
                                                                                    {% for key, value in  sign.value.items %}
                                                                                        <span class='text-info fw-bold'>{{key}}:</span>
                                                                                        <span>{{value}}</span><br />
                                                                                    {% endfor %}
                                                                                {% else %}
                                                                                    {{sign.value}}
                                                                                {% endif %}
                                                                            </td>
                                                                        {% endif %}
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% endif %}
                                            {% if signature.calls %}
                                                <div id="signature-calls_{{signature.name}}" class="mt-3"></div>
                                                {% with data_id="signature-calls-data_"|add:signature.name %}
                                                    {{ signature.calls | json_script:data_id }}
                                                    <script type="text/javascript">
                                                        $(document).ready(function(){
                                                            $("#signature_collapse_{{signature.name}}").one("show.bs.collapse", function() {
                                                                $.ajax(
                                                                    "{% url "signature-calls" task_id=analysis.info.id %}",
                                                                    {
                                                                        contentType: "application/json",
                                                                        data: document.getElementById("{{data_id}}").textContent,
                                                                        dataType: "html",
                                                                        method: "POST",
                                                                        success: function(responseText) {
                                                                            $("#signature-calls_{{signature.name}}").html(responseText);
                                                                        }
                                                                    }
                                                                );
                                                            });
                                                        });
                                                    </script>
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="p-3 text-center text-white-50">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-0">No suspicious signatures detected.</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}
