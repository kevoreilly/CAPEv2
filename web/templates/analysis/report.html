{% extends "base.html" %}
{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- 1. Tab Persistence Logic ---

        // Apply only when reloading the same page
        if (document.referrer === document.location.href) {
            const lastAnalysisTab = localStorage.getItem('lastAnalysisTab');

            if (lastAnalysisTab) {
                // Find the tab trigger that matches the stored selector
                const triggerEl = document.querySelector('a[data-bs-toggle="tab"][href="' + lastAnalysisTab + '"]');
                if (triggerEl) {
                    const tabInstance = new bootstrap.Tab(triggerEl);
                    tabInstance.show();
                }
            }
        }

        // Listen for tab switches to save the new selection
        // Select both standard tabs AND ajax tabs so we can save their state
        const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"], a[data-bs-toggle="tabajax"]');
        tabLinks.forEach(function (tabLink) {
            tabLink.addEventListener('shown.bs.tab', function (event) {
                // event.target is the active tab element
                localStorage.setItem('lastAnalysisTab', event.target.getAttribute('href'));
            });
        });


        // --- 2. AJAX Tab Logic ---

        const ajaxTabs = document.querySelectorAll('[data-bs-toggle="tabajax"]');

        ajaxTabs.forEach(function (tab) {
            tab.addEventListener('click', function (e) {
                e.preventDefault();

                const url = this.getAttribute('data-url');
                const targetSelector = this.getAttribute('href'); // e.g., "#profile"
                const targetPane = document.querySelector(targetSelector);

                if (url && targetPane) {
                    // Use standard Fetch API instead of jQuery .load()
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(html => {
                            // Inject the HTML into the pane
                            targetPane.innerHTML = html;

                            // Activate the tab using Bootstrap 5 API
                            const tabInstance = new bootstrap.Tab(this);
                            tabInstance.show();
                        })
                        .catch(error => {
                            console.error('Error loading tab content:', error);
                            targetPane.innerHTML = "Error loading content.";
                        });
                } else {
                    // No URL? Just show the tab normally
                    const tabInstance = new bootstrap.Tab(this);
                    tabInstance.show();
                }
            });
        });

    });
</script>

<script src="{{ STATIC_URL }}js/hexdump.js"></script>

<style type="text/css">
    .alert-tlp_green {
        background-color: #008000;
        padding: 3px;
        padding-left: 10px;
        margin-bottom: 3px;
        text-align: center;
        font-size: 12;
    }

    .alert-tlp_amber {
        background-color: #FFBF00;
        padding: 3px;
        padding-left: 10px;
        margin-bottom: 3px;
        text-align: center;
        font-size: 12;
    }

    .alert-tlp_red {
        background-color: #FF2626;
        padding: 3px;
        padding-left: 10px;
        margin-bottom: 3px;
        text-align: center;
        font-size: 12;
    }
</style>
{% if analysis.info.tlp %}
{% if analysis.info.tlp == "Red" %}
<div class="alert alert-tlp_red">
    {% elif analysis.info.tlp == "Amber" %}
    <div class="alert alert-tlp_amber">
        {% elif analysis.info.tlp == "Green" %}
        <div class="alert alert-tlp_amber">
            {% endif %}
        </div>
        {% endif %}
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#overview" data-bs-toggle="tab">Quick Overview</a>
            </li>

            {% if analysis.info.machine.platform == "linux" %}
            <li class="nav-item">
                <a class="nav-link" href="#strace" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/strace/">Behavioral Analysis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#tracee" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/tracee/">Detailed Behaviour (Tracee)</a>
            </li>
            {% elif analysis.info.category != "pcap" and analysis.info.category != "static" %}
            <li class="nav-item">
                <a class="nav-link" href="#behavior" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/behavior/">Behavioral Analysis</a>
            </li>
            {% endif %}

            {% if analysis.info.category != "static" %}
            <li class="nav-item">
                <a class="nav-link" href="#network" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/network/">Network Analysis</a>
            </li>
            {% endif %}

            {% if analysis.info.category != "pcap" and analysis.info.category != "static" %}
            {% if analysis.dropped %}
            <li class="nav-item">
                <a class="nav-link" href="#dropped" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/dropped/">Dropped Files
                    ({{analysis.dropped}})</a>
            </li>
            {% endif %}
            {% if analysis.procmemory %}
            <li class="nav-item">
                <a class="nav-link" href="#procmemory" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/procmemory/">Process Memory
                    ({{analysis.procmemory}})</a>
            </li>
            {% endif %}
            {% if analysis.memory %}
            <li class="nav-item">
                <a class="nav-link" href="#memory" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/memory/">Memory Analysis</a>
            </li>
            {% endif %}
            {% if analysis.procdump %}
            <li class="nav-item">
                <a class="nav-link" href="#procdump" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/procdump/">Process Dumps
                    ({{analysis.procdump}})</a>
            </li>
            {% endif %}
            {% if analysis.CAPE %}
            <li class="nav-item">
                <a class="nav-link" href="#CAPE" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/CAPE/">Payloads ({{analysis.CAPE}})</a>
            </li>
            {% endif%}
            {% if analysis.debugger_logs %}
            <li class="nav-item">
                <a class="nav-link" href="#debugger" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/debugger/">Debugger</a>
            </li>
            {% endif %}
            {% endif %}

            {% if settings.COMMENTS %}
            <li class="nav-item">
                <a class="nav-link" href="#comments" data-bs-toggle="tab">Comments {% if analysis.info.comments|length
                    %}({{analysis.info.comments|length}}){% endif %}</a>
            </li>
            {% endif %}

            {% if analysis.misp %}
            <li class="nav-item"><a class="nav-link" href="#misp" data-bs-toggle="tab">MISP</a></li>
            {% endif %}

            {% if analysis.backscatter %}
            <li class="nav-item"><a class="nav-link" href="#backscatter" data-bs-toggle="tab">Backscatter</a></li>
            {% endif %}

            {% if analysis.classification%}
            <li class="nav-item"><a class="nav-link" href="#classification" data-bs-toggle="tab">Classification</a></li>
            {% endif %}

            {% if analysis.info.category == "file" and analysis.target %}
            <li class="nav-item"><a class="nav-link" href="{% url " compare_left" analysis.info.id %}">Compare this
                    analysis
                    to...</a></li>
            {% endif %}

            {% if settings.ADMIN or user.is_staff %}
            <li class="nav-item"><a class="nav-link" href="#admin" data-bs-toggle="tab">Admin</a></li>
            {% endif %}
        </ul>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="overview">
                {% include "analysis/overview/index.html" %}
            </div>
            <div class="tab-pane fade" id="behavior">
                {% include "analysis/behavior/index.html" %}
            </div>
            <div class="tab-pane fade" id="strace">
                {% include "analysis/strace/index.html" %}
            </div>
            <div class="tab-pane fade" id="tracee">
                {% include "analysis/tracee/index.html" %}
            </div>
            <div class="tab-pane fade" id="network">
                {% include "analysis/network/index.html" %}
            </div>
            <div class="tab-pane fade" id="dropped">
                {% include "analysis/dropped/index.html" %}
            </div>
            {% if analysis.CAPE %}
            <div class="tab-pane fade" id="CAPE">
                {% include "analysis/CAPE/index.html" %}
            </div>
            {% endif %}
            <div class="tab-pane fade" id="procdump">
                {% include "analysis/procdump/index.html" %}
            </div>
            {% if analysis.procmemory %}
            <div class="tab-pane fade" id="procmemory">
                {% include "analysis/procmemory/index.html" %}
            </div>
            {% endif %}
            {% if analysis.memory %}
            <div class="tab-pane fade" id="memory">
                {% include "analysis/memory/index.html" %}
            </div>
            {% endif %}
            {% if config.malheur %}
            {% if analysis.info.category == "file" or analysis.info.category == "url" %}
            <div class="tab-pane fade" id="similar">
                {% include "analysis/similar/index.html" %}
            </div>
            {% endif %}
            {% endif %}
            {% if settings.COMMENTS %}
            <div class="tab-pane fade" id="comments">
                {% include "analysis/comments/index.html" %}
            </div>
            {% endif %}
            {% if analysis.misp %}
            <div class="tab-pane fade" id="misp">
                {% include "analysis/misp/index.html" %}
            </div>
            {% endif %}
            {% if analysis.debugger_logs %}
            <div class="tab-pane fade" id="debugger">
                {% include "analysis/debugger/index.html" %}
            </div>
            {% endif %}
            {% if analysis.backscatter %}
            <div class="tab-pane fade" id="backscatter">
                {% include "analysis/backscatter.html" %}
            </div>
            {% endif %}
            {% if analysis.classification %}
            <div class="tab-pane fade" id="classification">
                {% include "analysis/classification.html" %}
            </div>
            {% endif %}
            {% if settings.ADMIN or user.is_staff %}
            <div class="tab-pane fade" id="admin">
                {% include "analysis/admin/index.html" %}
            </div>
            {% endif %}
        </div>
        {% endblock %}
