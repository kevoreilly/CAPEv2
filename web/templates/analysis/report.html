{% extends "base.html" %}
{% block content %}
<script>
    $(function () {
        // 1. Tab Persistence Logic
        // Only restore if reloading the same page
        if (document.referrer === document.URL) {
            var lastAnalysisTab = localStorage.getItem('lastAnalysisTab');

            if (lastAnalysisTab) {
                // In BS5, use .tab('show') to activate a tab explicitly
                // Make sure to select the specific anchor tag
                $('a[data-bs-toggle="tab"][href="' + lastAnalysisTab + '"]').tab('show');
            }
        }

        // Listen for the BS5 specific 'shown' event to save the tab
        // 'shown.bs.tab' fires *after* the tab has successfully switched
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            // e.target is the newly active tab
            localStorage.setItem('lastAnalysisTab', $(e.target).attr('href'));
        });

        // 2. AJAX Tab Logic
        // Using a custom attribute 'data-bs-toggle="tabajax"'
        $('[data-bs-toggle="tabajax"]').on('click', function (e) {
            e.preventDefault(); // Best practice: prevent the link from jumping

            var $this = $(this),
                url = $this.attr("data-url"),
                targetPane = $this.attr('href'); // Get the #id of the target pane

            if (url) {
                // Load content via AJAX
                $(targetPane).load(url, function (result) {
                    // Once loaded, initialize and show the BS5 tab
                    $this.tab('show');
                });
            } else {
                // No URL? Just show the tab
                $this.tab('show');
            }
        });
    });
</script>

<script src="{{ STATIC_URL }}js/hexdump.js"></script>


<style type="text/css">
.alert-tlp_green {
    background-color: #008000;
    padding: 3px;
    padding-left: 10px;
    margin-bottom: 3px;
    text-align: center;
    font-size: 12;
}
.alert-tlp_amber {
    background-color: #FFBF00;
    padding: 3px;
    padding-left: 10px;
    margin-bottom: 3px;
    text-align: center;
    font-size: 12;
}
.alert-tlp_red {
    background-color: #FF2626;
    padding: 3px;
    padding-left: 10px;
    margin-bottom: 3px;
    text-align: center;
    font-size: 12;
}
</style>
{% if analysis.info.tlp %}
    {% if analysis.info.tlp == "Red" %}
    <div class="alert alert-tlp_red">
    {% elif analysis.info.tlp == "Amber" %}
    <div class="alert alert-tlp_amber">
    {% elif analysis.info.tlp == "Green" %}
        <div class="alert alert-tlp_amber">
    {% endif %}
    </div>
{% endif %}

<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" href="#overview" data-bs-toggle="tab">Quick Overview</a></li>
    {% if analysis.info.machine.platform == "linux" %}
        <li class="nav-item"><a class="nav-link" href="#strace" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/strace/" data-bs-toggle="tab">Behavioral Analysis</a></li>
        <li class="nav-item"><a class="nav-link" href="#tracee" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/tracee/" data-bs-toggle="tab">Detailed Behaviour (Tracee)</a></li>
    {% elif analysis.info.category != "pcap" and analysis.info.category != "static" %}
        <li class="nav-item"><a class="nav-link" href="#behavior" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/behavior/" data-bs-toggle="tab">Behavioral Analysis</a></li>
    {% endif %}
    {% if analysis.info.category != "static" %}
        <li class="nav-item"><a class="nav-link" href="#network" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/network/" data-bs-toggle="tab">Network Analysis</a></li>
    {% endif %}
    {% if analysis.info.category != "pcap" and analysis.info.category != "static" %}
        {% if analysis.dropped %}
            <li class="nav-item"><a class="nav-link" href="#dropped" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/dropped/" data-bs-toggle="tab">Dropped Files ({{analysis.dropped}})</a></li>
        {% endif %}
        {% if analysis.procmemory %}
            <li class="nav-item"><a class="nav-link" href="#procmemory" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/procmemory/" data-bs-toggle="tab" >Process Memory ({{analysis.procmemory}})</a></li>
        {% endif %}
        {% if analysis.memory %}
            <li class="nav-item"><a class="nav-link" href="#memory" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/memory/" data-bs-toggle="tab">Memory Analysis</a></li>
        {% endif %}
        {% if analysis.procdump %}
            <li class="nav-item"><a class="nav-link" href="#procdump" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/procdump/">Process Dumps ({{analysis.procdump}})</a></li>
        {% endif %}
        {% if analysis.CAPE %}
            <li class="nav-item"><a class="nav-link" href="#CAPE" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/CAPE/" data-bs-toggle="tab">Payloads ({{analysis.CAPE}})</a></li>
        {% endif%}
        {% if analysis.debugger_logs %}
            <li class="nav-item"><a class="nav-link" href="#debugger" data-bs-toggle="tabajax" data-url="/analysis/load_files/{{analysis.info.id}}/debugger/" data-bs-toggle="tab">Debugger</a></li>
        {% endif %}
    {% endif %}
    {% if settings.COMMENTS %}
        {% if analysis.info.comments|length %}
            <li class="nav-item"><a class="nav-link" href="#comments" data-bs-toggle="tab">Comments ({{analysis.info.comments|length}})</a></li>
        {% else %}
            <li class="nav-item"><a class="nav-link" href="#comments" data-bs-toggle="tab">Comments</a></li>
        {% endif %}
    {% endif %}
    {% if analysis.misp %}
            <li class="nav-item"><a class="nav-link" href="#misp" data-bs-toggle="tab">MISP</a></li>
    {% endif %}
    {% if analysis.backscatter %}<li class="nav-item"><a class="nav-link" href="#backscatter" data-bs-toggle="tab">Backscatter</a></li>{% endif %}
    {% if analysis.classification%}<li class="nav-item"><a class="nav-link" href="#classification" data-bs-toggle="tab">Classification</a> </li>{% endif %}
     {% if analysis.info.category == "file" and analysis.target %}<li class="nav-item"><a class="nav-link" href="{% url "compare_left" analysis.info.id %}">Compare this analysis to...</a></li>{% endif %}
    {% if settings.ADMIN or user.is_staff %}<li class="nav-item"><a class="nav-link" href="#admin" data-bs-toggle="tab">Admin</a></li>{% endif %}
</ul>
<div class="tab-content">
    <div class="tab-pane fade show active" id="overview">
        {% include "analysis/overview/index.html" %}
    </div>
    <div class="tab-pane fade" id="behavior">
        {% include "analysis/behavior/index.html" %}
    </div>
    <div class="tab-pane fade" id="strace">
        {% include "analysis/strace/index.html" %}
    </div>
    <div class="tab-pane fade" id="tracee">
        {% include "analysis/tracee/index.html" %}
    </div>
    <div class="tab-pane fade" id="network">
        {% include "analysis/network/index.html" %}
    </div>
    <div class="tab-pane fade" id="dropped">
        {% include "analysis/dropped/index.html" %}
    </div>
    {% if analysis.CAPE %}
        <div class="tab-pane fade" id="CAPE">
        {% include "analysis/CAPE/index.html" %}
        </div>
    {% endif %}
    <div class="tab-pane fade" id="procdump">
        {% include "analysis/procdump/index.html" %}
    </div>
    {% if analysis.procmemory %}
    <div class="tab-pane fade" id="procmemory">
        {% include "analysis/procmemory/index.html" %}
    </div>
    {% endif %}
    {% if analysis.memory %}
        <div class="tab-pane fade" id="memory">
            {% include "analysis/memory/index.html" %}
        </div>
    {% endif %}
    {% if config.malheur %}
        {% if analysis.info.category == "file" or analysis.info.category == "url" %}
        <div class="tab-pane fade" id="similar">
            {% include "analysis/similar/index.html" %}
        </div>
        {% endif %}
    {% endif %}
    {% if settings.COMMENTS %}
    <div class="tab-pane fade" id="comments">
        {% include "analysis/comments/index.html" %}
    </div>
    {% endif %}
    {% if analysis.misp %}
    <div class="tab-pane fade" id="misp">
        {% include "analysis/misp/index.html" %}
    </div>
    {% endif %}
    {% if analysis.debugger_logs %}
        <div class="tab-pane fade" id="debugger">
            {% include "analysis/debugger/index.html" %}
        </div>
    {% endif %}
    {% if analysis.backscatter %}
    <div class="tab-pane fade" id="backscatter">
        {% include "analysis/backscatter.html" %}
    </div>
    {% endif %}
    {% if analysis.classification %}
    <div class="tab-pane fade" id="classification">
        {% include "analysis/classification.html" %}
    </div>
    {% endif %}
    {% if settings.ADMIN or user.is_staff %}
    <div class="tab-pane fade" id="admin">
        {% include "analysis/admin/index.html" %}
    </div>
    {% endif %}
</div>
{% endblock %}
