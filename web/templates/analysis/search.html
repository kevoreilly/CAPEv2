{% extends "base.html" %}
{% load i18n %}
{% block content %}
<div class="row">
    <div class="col-md-0 mx-auto">
        <form class="form-inline" role="form" action="{% url "search" %}" method="get">
            <div class="form-group">
                <label class="sr-only" for="form_search">{% trans "Search term" %}</label>
                <input type="text" class="form-control" id="form_search" name="search" size=50 placeholder="{% trans "Search term as regex" %}" />
            </div>
            <button type="submit" class="btn btn-secondary">{% trans "Search" %}</button>
        </form>
        <p class="text-muted" style="margin-top: 5px;">{% blocktrans %}For details on how to perform searches, get some <a href="#help" aria-expanded="false" aria-controls="#help" data-toggle="collapse">help</a>.{% endblocktrans %}</p>
        <div id="help" class="collapse">
            <p class="text-muted" style="margin-top: 10px;">{% trans "ElasticSearch queries do not use a prefix. For example '*windows.*' would match 'time.windows.com'." %}</p>
            <p class="text-muted" style="margin-top: 10px;">{% trans "For MD5, SHA1, SHA3, SHA256 and SHA512 no prefix is needed (will match any file generated by this analysis as binary/dropped/CAPEdump/etc)." %}</p>
            <table class="table table-striped table-centered table-hover">
                <thead>
                    <tr>
                        <th style="text-align: center;">{% trans "Prefix" %}</th>
                        <th style="text-align: center;">{% trans "Description" %}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>target_sha256:</code></td>
                        <td>{% trans "SHA256 hash" %}</td>
                    </tr>
                    <tr>
                        <td><code>configs:</code></td>
                        <td>{% trans "Family name" %}</td>
                    </tr>

                    <tr>
                        <td><code>id:</code></td>
                        <td>{% blocktrans %}task_id, e.g. id:1{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>ids:</code></td>
                        <td>{% blocktrans %}task_ids, e.g. ids:1,2,3,4,5{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>options:</code></td>
                        <td>{% blocktrans %}x=y, e.g. options:function=DllMain{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>tags_tasks:</code></td>
                        <td>{% blocktrans %}Tag name, e.g. tags_tasks:mytag{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>package:</code></td>
                        <td>{% blocktrans %}Package, e.g. package:ps1{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>name:</code></td>
                        <td>{% trans "File name pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>type:</code></td>
                        <td>{% trans "File type/format" %}</td>
                    </tr>
                    <tr>
                        <td><code>ssdeep:</code></td>
                        <td>{% trans "Fuzzy hash" %}</td>
                    </tr>
                    <tr>
                        <td><code>crc32:</code></td>
                        <td>{% trans "CRC32 hash" %}</td>
                    </tr>
                    <tr>
                        <td><code>imphash:</code></td>
                        <td>{% trans "Search for PE Imphash" %}</td>
                    </tr>
                    <tr>
                        <td><code>iconhash:</code></td>
                        <td>{% trans "Search for exact hash of the icon associated with the PE" %}</td>
                    </tr>
                    <tr>
                        <td><code>iconfuzzy:</code></td>
                        <td>{% trans "Search for hash designed to match on similar-looking icons" %}</td>
                    </tr>
                    <tr>
                        <td><code>file:</code></td>
                        <td>{% trans "Open files matching the pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>command:</code></td>
                        <td>{% trans "Executed commands matching the pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>resolvedapi:</code></td>
                        <td>{% trans "APIs resolved at runtime matching the pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>key:</code></td>
                        <td>{% trans "Open registry keys matching the pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>mutex:</code></td>
                        <td>{% trans "Open mutexes matching the pattern" %}</td>
                    </tr>
                    <tr>
                        <td><code>sport:</code></td>
                        <td>{% blocktrans %}Source port, e.g. sport:X{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>dport:</code></td>
                        <td>{% blocktrans %}Destination port, e.g. dport:443{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>port:</code></td>
                        <td>{% blocktrans %}Search both source and destination ports, e.g. port:x{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>ip:</code></td>
                        <td>{% trans "Contact the specified IP address" %}</td>
                    </tr>
                    <tr>
                        <td><code>domain:</code></td>
                        <td>{% trans "Contact the specified domain" %}</td>
                    </tr>
                    <tr>
                        <td><code>url:</code></td>
                        <td>{% trans "Search for CAPE Sandbox URL analysis" %}</td>
                    </tr>
                    <tr>
                        <td><code>signame:</code></td>
                        <td>{% trans "Search for CAPE Sandbox signatures through signature names" %}</td>
                    </tr>
                    <tr>
                        <td><code>signature:</code></td>
                        <td>{% trans "Search for CAPE Sandbox signatures through signature descriptions" %}</td>
                    </tr>
                    <tr>
                        <td><code>detections:</code></td>
                        <td>{% trans "Search for samples associated with malware family" %}</td>
                    </tr>
                    <tr>
                        <td><code>surimsg:</code></td>
                        <td>{% trans "Search for Suricata alert messages" %}</td>
                    </tr>
                    <tr>
                        <td><code>surialert:</code></td>
                        <td>{% trans "Search for Suricata alerts" %}</td>
                    </tr>
                    <tr>
                        <td><code>surisid:</code></td>
                        <td>{% trans "Search for Suricata alert SIDs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suriurl:</code></td>
                        <td>{% trans "Search for URLs in Suricata HTTP logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suriua:</code></td>
                        <td>{% trans "Search for User-Agent strings in Suricata HTTP logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>surireferrer:</code></td>
                        <td>{% trans "Search for Referrer values in Suricata HTTP logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>surihhost:</code></td>
                        <td>{% trans "Search for Host values in Suricata HTTP logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suritlssubject:</code></td>
                        <td>{% trans "Search for TLS Subject in Suricata TLS logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suritlsissuerdn:</code></td>
                        <td>{% trans "Search for TLS Issuer DN in Suricata TLS logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suritlsfingerprint:</code></td>
                        <td>{% trans "Search for TLS fingerprint in Suricata TLS logs" %}</td>
                    </tr>
                    <tr>
                        <td><code>suritls:</code></td>
                        <td>{% trans "Search for Suricata TLS entries" %}</td>
                    </tr>
                    <tr>
                        <td><code>surihttp:</code></td>
                        <td>{% trans "Search for Suricata HTTP entries" %}</td>
                    </tr>
                    <tr>
                        <td><code>ja3_string:</code></td>
                        <td>{% trans "Search for JA3 string" %}</td>
                    </tr>
                    <tr>
                        <td><code>ja3_hash:</code></td>
                        <td>{% trans "Search for JA3 hash" %}</td>
                    </tr>
                    <tr>
                        <td><code>clamav:</code></td>
                        <td>{% trans "Local ClamAV detections" %}</td>
                    </tr>
                    <tr>
                        <td><code>yaraname:</code></td>
                        <td>{% trans "Yara rule name for analysis samples (binary folder)" %}</td>
                    </tr>
                    <tr>
                        <td><code>capeyara:</code></td>
                        <td>{% trans "Yara rule name for CAPE Yara hits (cape folder)" %}</td>
                    </tr>
                    <tr>
                        <td><code>procdumpyara:</code></td>
                        <td>{% trans "Yara rule name for process dumps" %}</td>
                    </tr>
                    <tr>
                        <td><code>procmemyara:</code></td>
                        <td>{% trans "Yara rule name for process memory dumps" %}</td>
                    </tr>
                    <tr>
                        <td><code>virustotal:</code></td>
                        <td>{% trans "VirusTotal detected name" %}</td>
                    </tr>
                    <tr>
                        <td><code>machinename:</code></td>
                        <td>{% trans "Name of the target machine" %}</td>
                    </tr>
                    <tr>
                        <td><code>machinelabel:</code></td>
                        <td>{% trans "Label of the target machine" %}</td>
                    </tr>
                    <tr>
                        <td><code>custom:</code></td>
                        <td>{% trans "Custom data" %}</td>
                    </tr>
                    <tr>
                        <td><code>comment:</code></td>
                        <td>{% trans "Search for analysis comments" %}</td>
                    </tr>
                    <tr>
                        <td><code>malscore:</code></td>
                        <td>{% trans "Search for malscore greater than a value" %}</td>
                    </tr>
                    <tr>
                        <td><code>ttp:</code></td>
                        <td>{% blocktrans %}TTP id, e.g. T1053{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>dhash:</code></td>
                        <td>{% trans "dhash value" %}</td>
                    </tr>
                    <tr>
                        <td><code>die:</code></td>
                        <td>{% blocktrans %}Fingerprint produced by DIE, e.g. die:obsidium{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>extracted_tool:</code></td>
                        <td>{% blocktrans %}Extracted tool name, e.g. extracted_tool:InnoExtract (see file_extra_info.py for all names){% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>asn:</code></td>
                        <td>{% blocktrans %}Autonomous system ID, e.g. asn:AS15169{% endblocktrans %}</td>
                    </tr>
                    <tr>
                        <td><code>asn_name:</code></td>
                        <td>{% blocktrans %}ASN name, e.g. asn_name:Google LLC{% endblocktrans %}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% if term %}
    <h3>{% trans "Term" %} <span class="text-danger"><i>{{term}}</i></span>
    {% if settings.ZIPPED_DOWNLOAD_ALL and term_only in 'capetype,capeyara' %}
        <center><a href="{% url 'file' term_only|add:'zipall' '1' value_only %}" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" title="{% trans "Download password-protected archive with every file matching the searched term (not only the original target)." %}"><span class="fas fa-file-archive"></span> <span class="fas fa-download"></span> {% trans "Download All Files" %}</a></center>
    {% endif %}
    </h3>
{% endif %}
{% if analyses != None %}
    {% if analyses|length > 0 %}
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">{% trans "Search Results" %}</h3>
            </div>
            <table class="table table-striped table-ms" style="table-layout: fixed;">
                <thead>
                <tr>
                    <th width="5%">{% trans "ID" %}</th>
                    <th width="10%">{% trans "Timestamp" %}</th>
                    <th width="8%">{% trans "Package" %}</th>
                    <th width="37%">{% trans "Filename" %}</th>
                    <th width="20%">{% trans "Target" %}</th>
                    <th width="7%">{% trans "Detections" %}</th>
                    {% if config.expanded_dashboard %}
                    <th width="2.5%">{% trans "PKG" %}</th>
                    {% endif %}
                    {% if config.moloch %}
                    <th width="5%">Moloch</th>
                    {% endif %}
                    {% if config.display_office_martians or config.display_browser_martians%}
                    <th width="5%">{% trans "Martians" %}</th>
                    {% endif %}
                    {% if config.suricata %}
                    <th width="7%">{% trans "SuriAlert" %}
                        {% if config.expanded_dashboard %}
                        /HTTP/TLS/{% trans "Files" %}
                        {% endif %}
                    </th>
                    {% endif %}
                    {% if config.virustotal %}
                    <th width="5%">VT</th>
                    {% endif %}
                    {% if config.malscore %}
                    <th width="5%">{% trans "MalScore" %}</th>
                    {% endif %}
                    {% if config.expanded_dashboard %}
                    <th width="4%">{% trans "Detections" %}</th>
                    <th width="3%">PCAP</th>
                    <th width="5%">ClamAV</th>
                    <th width="10%">{% trans "Custom" %}</th>
                    {% endif %}
                    <th width="7%" style="text-align: right;">{% trans "Status" %}</th>
                </tr>
                </thead>
                <tbody>
                {% for analysis in analyses %}
                    <tr>
                        <td>
                            {{analysis.id}}
                        </td>
                        <td>
                        {% if analysis.status == "reported" %}
                            {{analysis.completed_on}}
                        {% else %}
                            <span class="muted">{{analysis.added_on}} {% trans "(added on)" %}</span>
                        {% endif %}
                        </td>
                        <td>
                        {{analysis.package}}
                        </td>
                        <td>
                        {% if analysis.filename %}
                            {{analysis.filename}}
                        {% else %}
                            {% trans "None" %}
                        {% endif %}
                        </td>
                        <td style="word-wrap: break-word;">
                            {% if analysis.status == "reported" %}
                                <a href="{% url "report" analysis.id %}">
                                {% if analysis.category == "url" %}
                                    <span class="mono">{{analysis.target}}</span>
                                {% else %}
                                    <span class="mono">{{analysis.sample.md5}}</span>
                                {% endif %}
                                </a>
                            {% else %}
                                {% if analysis.category == "url" %}
                                    <span class="mono">{{analysis.target}}</span>
                                {% else %}
                                    <span class="mono">{{analysis.sample.md5}}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if analysis.detections %}
                                <!--ToDo get_type is to show correctly old detection. so To be removed. 1 detection we show the name, more detection we show multi and add tooltip-->
                                {% if analysis.detections|is_string %}
                                    <a href="/analysis/search/detections:{{analysis.detections}}"><span style="color:#EE1B2F;font-weight: bold;">{{analysis.detections}}</span></a>
                                {% elif analysis.detections|length == 1 %}
                                    <a href="/analysis/search/detections:{{analysis.detections.0.family}}"><span style="color:#EE1B2F;font-weight: bold;">{{analysis.detections.0.family}}</span></a>
                                {% elif analysis.detections|length > 1 %}
                                    <span style="color:#EE1B2F;font-weight: bold;" title="{% for block in analysis.detections %}{% if block.family %}{{block.family}}&#013;{% endif %}{% endfor %}">{% trans "Multiple" %}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        {% if config.expanded_dashboard %}
                        <td>
                            {% if analysis.package %}
                                  <span class="mono">{{analysis.package}}</span>
                            {% else %}
                                  <span class="mono">{% trans "None" %}</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% if config.moloch %}
                        <td>
                            {% if analysis.moloch_url %}
                                <a href={{analysis.moloch_url}} target="_blank"><span class="mono">MOLOCH</span></a>
                            {% else %}
                                  <span class="mono">{% trans "None" %}</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% if analysis.category == "url" %}
                            {% if config.display_browser_martians %}
                                 <td>
                                     <span class="mono">
                                     {% if analysis.mlist_cnt %}
                                         {{analysis.mlist_cnt}}
                                     {% else %}
                                         {% trans "None" %}
                                     {% endif %}
                                    </span>
                                </td>
                            {% endif %}
                        {% else %}
                            {% if config.display_office_martians %}
                                <td>
                                    <span class="mono">
                                    {% if analysis.f_mlist_cnt %}
                                        {{analysis.f_mlist_cnt}}
                                    {% else %}
                                        {% trans "None" %}
                                    {% endif %}
                                    </span>
                                </td>
                            {% endif %}
                        {% endif %}
                        {% if config.suricata %}
                        <td>
                            <span class="mono">
                            {% if analysis.suri_alert_cnt %}
                            <a href="{% url "surialert" analysis.id %}" target="_blank">{{analysis.suri_alert_cnt}}</a><!--
                            {% else %}
                            0<!--
                            {% endif %}
                            {% if config.expanded_dashboard %}
                                {% if analysis.suri_http_cnt %}
                                -->/<a href="{% url "surihttp" analysis.id %}" target="_blank">{{analysis.suri_http_cnt}}</a><!--
                                {% else %}
                                -->/0<!--
                                {% endif %}
                                {% if analysis.suri_tls_cnt %}
                                -->/<a href="{% url "suritls" analysis.id %}" target="_blank">{{analysis.suri_tls_cnt}}</a><!--
                                {% else %}
                                -->/0<!--
                                {% endif %}
                                {% if analysis.suri_file_cnt %}
                                -->/<a href="{% url "surifiles" analysis.id %}" target="_blank">{{analysis.suri_file_cnt}}</a><!--
                                {% else %}
                                -->/0<!--
                                {% endif %}
                            {% endif %}
                            --></span>
                        </td>
                        {% endif %}
                        {% if config.virustotal %}
                        <td>
                            {% if analysis.virustotal_summary %}
                                <a href="{% url "antivirus" analysis.id %}" target="_blank"><span class="mono">{{analysis.virustotal_summary}}</span></a>
                            {% else %}
                                  <span class="mono">{% trans "None" %}</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% if config.malscore %}
                        <td>
                            {% if analysis.malscore != None %}
                                <span
                                {% if analysis.malscore <= 2.0 %}
                                class="badge badge-success"
                                {% elif analysis.malscore <= 6.0 %}
                                class="badge badge-warning"
                                {% else %}
                                class="badge badge-danger"
                                {% endif %}
                                {% if analysis.detections %}
                                title="{{analysis.detections}}"
                                {% endif %}
                                >{{analysis.malscore|floatformat:1}}</span>
                            {% else %}
                                <span class="mono">{% trans "None" %}</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% if config.expanded_dashboard %}
                        <td>
                            <span class="mono">
                                {% if analysis.detections %}
                                {{analysis.detections}}
                                {% else %}
                                {% trans "None" %}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="mono">
                            {% if analysis.pcap_sha256 %}
                            <a href="{% url "file" "pcap" analysis.id analysis.pcap_sha256 %}" target="_blank">PCAP</a>
                            {% else %}
                            {% trans "None" %}
                            {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="mono">
                            {% if analysis.clamav %}
                                {{analysis.clamav}}
                            {% else %}
                                {% trans "None" %}
                            {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="mono">
                            {% if analysis.custom %}
                                {{analysis.custom}}
                            {% else %}
                                {% trans "None" %}
                            {% endif %}
                            </span>
                        </td>
                        {% endif %}
                        <td style="text-align: right;">
                            {% if analysis.status == "pending" %}
                                <span class="text-muted">{% trans "Pending" %}</span>
                            {% elif analysis.status == "running" %}
                                <span class="text-warning">{% trans "Running" %}</span>
                            {% elif analysis.status == "completed" %}
                                <span class="text-info">{% trans "Processing" %}</span>
                            {% elif analysis.status == "reported" %}
                                {% if analysis.errors %}
                                    <span class="text-danger">
                                {% else %}
                                    <span class="text-success">
                                {% endif%}

                                {% trans "Reported" %}</span>
                            {% else %}
                                <span class="text-danger">{{analysis.status}}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-danger" style="text-align: center;"><b>{% trans "No results found." %}</b></div>
    {% endif %}
{% else %}
    {% if error %}
        <div class="alert alert-error" style="text-align: center;"><b>{{error}}</b></div>
    {% endif %}
{% endif %}
{% endblock %}
