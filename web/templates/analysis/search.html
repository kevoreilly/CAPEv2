{% extends "base.html" %}
{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark shadow-sm border-secondary">
            <div class="card-body">
                <form role="form" action="{% url "search" %}" method="get">
                    <div class="input-group w-50 mx-auto">
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="form_search" name="search" placeholder="Search term (exact match by default)..." aria-label="Search">
                        <button class="btn btn-outline-info" type="submit"><i class="fas fa-search"></i> Search</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <p class="text-white-50 mb-0">Need help? <a href="#help" class="text-info" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="help">Click here for search syntax <i class="fas fa-chevron-down"></i></a></p>
                </div>
            </div>
        </div>

        <div id="help" class="collapse mt-3 w-75 mx-auto">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="mb-0 text-white"><i class="fas fa-info-circle me-2"></i> Search Help</h5>
                </div>
                <div class="card-body">
                    <p class="text-white-50">ElasticSearch queries do not use a prefix. e.g., <code>*windows.*</code> matches 'time.windows.com'.</p>
                    <p class="text-white-50">For MD5, SHA1, SHA256, etc., no prefix is needed (matches any file generated by analysis).</p>
                    <p class="text-white-50">By default, searches are exact matches. Use regex characters (e.g., <code>^ $ | ? * + ( ) [ ] { }</code>) to force a regex search.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-dark table-hover table-sm">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 20%;">Prefix</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- General / Metadata -->
                                <tr class="table-secondary"><th colspan="2" class="text-center text-white">General & Metadata</th></tr>
                                <tr><td class="text-center"><code>id:</code></td><td>Task ID (e.g., <code>id:1</code>)</td></tr>
                                <tr><td class="text-center"><code>ids:</code></td><td>List of Task IDs (e.g., <code>ids:1,2,3</code>)</td></tr>
                                <tr><td class="text-center"><code>options:</code></td><td>Task options (e.g., <code>options:function=DllMain</code>)</td></tr>
                                <tr><td class="text-center"><code>tags_tasks:</code></td><td>Task tags (e.g., <code>tags_tasks:mytag</code>)</td></tr>
                                <tr><td class="text-center"><code>package:</code></td><td>Analysis package (e.g., <code>package:ps1</code>)</td></tr>
                                <tr><td class="text-center"><code>machinename:</code></td><td>Target Machine Name</td></tr>
                                <tr><td class="text-center"><code>machinelabel:</code></td><td>Target Machine Label</td></tr>
                                <tr><td class="text-center"><code>custom:</code></td><td>Custom data field</td></tr>
                                <tr><td class="text-center"><code>comment:</code></td><td>Analysis Comments</td></tr>
                                <tr><td class="text-center"><code>configs:</code></td><td>Extracted config value</td></tr>

                                <!-- File Analysis -->
                                <tr class="table-secondary"><th colspan="2" class="text-center text-white">File Properties & Static Analysis</th></tr>
                                <tr><td class="text-center"><code>target_sha256:</code></td><td>Target file SHA256</td></tr>
                                <tr><td class="text-center"><code>name:</code></td><td>File name pattern</td></tr>
                                <tr><td class="text-center"><code>type:</code></td><td>File type/format</td></tr>
                                <tr><td class="text-center"><code>ssdeep:</code></td><td>Fuzzy hash (SSDeep)</td></tr>
                                <tr><td class="text-center"><code>crc32:</code></td><td>CRC32 hash</td></tr>
                                <tr><td class="text-center"><code>imphash:</code></td><td>PE Imphash</td></tr>
                                <tr><td class="text-center"><code>iconhash:</code></td><td>Exact icon hash</td></tr>
                                <tr><td class="text-center"><code>iconfuzzy:</code></td><td>Fuzzy icon hash</td></tr>
                                <tr><td class="text-center"><code>dhash:</code></td><td>Icon dhash</td></tr>
                                <tr><td class="text-center"><code>die:</code></td><td>Detect It Easy (DIE) signature (e.g., <code>die:obsidium</code>)</td></tr>
                                <tr><td class="text-center"><code>extracted_tool:</code></td><td>Extracted tool (e.g., <code>InnoExtract</code>)</td></tr>
                                <tr><td class="text-center"><code>virustotal:</code></td><td>VirusTotal Detected Name</td></tr>
                                <tr><td class="text-center"><code>clamav:</code></td><td>Local ClamAV detections</td></tr>
                                <tr><td class="text-center"><code>yaraname:</code></td><td>Yara Rule Name (binary folder)</td></tr>
                                <tr><td class="text-center"><code>capeyara:</code></td><td>Yara Rule Name (cape folder)</td></tr>
                                <tr><td class="text-center"><code>procdumpyara:</code></td><td>Yara Rule Name (process dumps)</td></tr>
                                <tr><td class="text-center"><code>procmemyara:</code></td><td>Yara Rule Name (memory dumps)</td></tr>

                                <!-- Network Analysis -->
                                <tr class="table-secondary"><th colspan="2" class="text-center text-white">Network Analysis</th></tr>
                                <tr><td class="text-center"><code>ip:</code></td><td>Contacted IP address</td></tr>
                                <tr><td class="text-center"><code>domain:</code></td><td>Contacted domain</td></tr>
                                <tr><td class="text-center"><code>url:</code></td><td>Contacted URL or URL Analysis Target</td></tr>
                                <tr><td class="text-center"><code>port:</code></td><td>Source or Destination port</td></tr>
                                <tr><td class="text-center"><code>sport:</code></td><td>Source port</td></tr>
                                <tr><td class="text-center"><code>dport:</code></td><td>Destination port</td></tr>
                                <tr><td class="text-center"><code>ja3_string:</code></td><td>JA3 string</td></tr>
                                <tr><td class="text-center"><code>ja3_hash:</code></td><td>JA3 hash</td></tr>
                                <tr><td class="text-center"><code>asn:</code></td><td>AS ID (e.g., <code>asn:AS15169</code>)</td></tr>
                                <tr><td class="text-center"><code>asn_name:</code></td><td>ASN name (e.g., <code>asn_name:Google LLC</code>)</td></tr>
                                <tr><td class="text-center"><code>surimsg:</code></td><td>Suricata Alert Message</td></tr>
                                <tr><td class="text-center"><code>surialert:</code></td><td>Suricata Alert Category</td></tr>
                                <tr><td class="text-center"><code>surisid:</code></td><td>Suricata Alert SID</td></tr>
                                <tr><td class="text-center"><code>suriurl:</code></td><td>Suricata HTTP URL</td></tr>
                                <tr><td class="text-center"><code>suriua:</code></td><td>Suricata HTTP User-Agent</td></tr>
                                <tr><td class="text-center"><code>surireferrer:</code></td><td>Suricata HTTP Referrer</td></tr>
                                <tr><td class="text-center"><code>surihost:</code></td><td>Suricata HTTP Host</td></tr>
                                <tr><td class="text-center"><code>suritlssubject:</code></td><td>Suricata TLS Subject</td></tr>
                                <tr><td class="text-center"><code>suritlsissuerdn:</code></td><td>Suricata TLS Issuer DN</td></tr>
                                <tr><td class="text-center"><code>suritlsfingerprint:</code></td><td>Suricata TLS Fingerprint</td></tr>
                                <tr><td class="text-center"><code>suritls:</code></td><td>Suricata TLS Generic</td></tr>
                                <tr><td class="text-center"><code>surihttp:</code></td><td>Suricata HTTP Generic</td></tr>

                                <!-- Behavioral / Dynamic Analysis -->
                                <tr class="table-secondary"><th colspan="2" class="text-center text-white">Behavior & Execution</th></tr>
                                <tr><td class="text-center"><code>file:</code></td><td>Open files matching pattern</td></tr>
                                <tr><td class="text-center"><code>command:</code></td><td>Executed commands matching pattern</td></tr>
                                <tr><td class="text-center"><code>resolvedapi:</code></td><td>APIs resolved at runtime</td></tr>
                                <tr><td class="text-center"><code>key:</code></td><td>Open registry keys matching pattern</td></tr>
                                <tr><td class="text-center"><code>mutex:</code></td><td>Open mutexes matching pattern</td></tr>
                                <tr><td class="text-center"><code>signame:</code></td><td>CAPE Signature names</td></tr>
                                <tr><td class="text-center"><code>signature:</code></td><td>CAPE Signature descriptions</td></tr>
                                <tr><td class="text-center"><code>detections:</code></td><td>Malware family detections</td></tr>
                                <tr><td class="text-center"><code>malscore:</code></td><td>Malscore > value</td></tr>
                                <tr><td class="text-center"><code>ttp:</code></td><td>TTP ID (e.g., <code>T1053</code>)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if term %}
<div class="row mb-3">
    <div class="col-12 text-white-50 text-center">
        <h3>Results for term: <span class="text-danger font-weight-bold">{{term}}</span></h3>
        {% if settings.ZIPPED_DOWNLOAD_ALL and term_only in 'capetype,capeyara' %}
            <a href="{% url 'file' term_only|add:'zipall' '1' value_only %}" class="btn btn-sm btn-outline-warning mt-2" data-bs-toggle="tooltip" title="Download password-protected archive with all matching files."><i class="fas fa-file-archive me-1"></i> Download All Matches</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% if analyses != None %}
    {% if analyses|length > 0 %}
        <div class="card bg-dark shadow-sm border-secondary mb-4">
            <div class="card-header border-secondary bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white"><i class="fas fa-list me-2"></i> Search Results</h5>
                <span class="badge bg-dark">{{analyses|length}} items</span>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover table-striped mb-0" style="table-layout: fixed;">
                    <thead class="thead-dark">
                    <tr>
                        <th width="5%" class="border-top-0">ID</th>
                        <th width="11%" class="border-top-0">Timestamp</th>
                        <th width="7%" class="border-top-0">Package</th>
                        <th width="25%" class="border-top-0">Filename</th>
                        <th width="18%" class="border-top-0">Target</th>
                        <th width="9%" class="border-top-0">Detections</th>
                        {% if config.moloch %}
                        <th width="5%" class="border-top-0">Moloch</th>
                        {% endif %}
                        {% if config.display_office_martians or config.display_browser_martians%}
                        <th width="5%" class="border-top-0">Martians</th>
                        {% endif %}
                        {% if config.suricata %}
                        <th width="7%" class="border-top-0">SuriAlert </th>
                        {% endif %}
                        {% if config.virustotal %}
                        <th width="5%" class="border-top-0">VT</th>
                        {% endif %}
                        {% if config.malscore %}
                        <th width="5%" class="border-top-0">MalScore</th>
                        {% endif %}
                        {% if config.expanded_dashboard %}
                        <th width="5%" class="border-top-0">PCAP</th>
                        {% if config.display_clamav %}
                            <th width="6%" class="border-top-0">ClamAV</th>
                        {% endif %}
                        {% endif %}
                        <th width="7%" class="border-top-0 text-end">Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for analysis in analyses %}
                        <tr>
                            <td>
                                <span class="font-weight-bold">{{analysis.id}}</span>
                            </td>
                            <td>
                            {% if analysis.status == "reported" %}
                                {{analysis.completed_on}}
                            {% else %}
                                <span class="text-white-50 small">{{analysis.added_on}} (added)</span>
                            {% endif %}
                            </td>
                            <td>
                                <span class="badge text-white bg-dark border border-secondary">{{analysis.package}}</span>
                            </td>
                            <td class="text-truncate" title="{{analysis.filename}}">
                            {% if analysis.filename %}
                                {{analysis.filename}}
                            {% else %}
                                <span class="text-white-50">-</span>
                            {% endif %}
                            </td>
                            <td class="text-truncate font-monospace small" title="{% if analysis.category == 'url' %}{{analysis.target}}{% else %}{{analysis.sample.md5}}{% endif %}">
                                {% if analysis.status == "reported" %}
                                    <a href="{% url "report" analysis.id %}" class="text-light">
                                    {% if analysis.category == "url" %}
                                        {{analysis.target}}
                                    {% else %}
                                        {{analysis.sample.md5}}
                                    {% endif %}
                                    </a>
                                {% else %}
                                    {% if analysis.category == "url" %}
                                        {{analysis.target}}
                                    {% else %}
                                        {{analysis.sample.md5}}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if analysis.detections %}
                                    {% if analysis.detections|is_string %}
                                        <a href="/analysis/search/detections:{{analysis.detections}}" class="badge bg-danger">{{analysis.detections}}</a>
                                    {% elif analysis.detections|length == 1 %}
                                        <a href="/analysis/search/detections:{{analysis.detections.0.family}}" class="badge bg-danger">{{analysis.detections.0.family}}</a>
                                    {% elif analysis.detections|length > 1 %}
                                        <span class="badge bg-danger" data-bs-toggle="tooltip" title="{% for block in analysis.detections %}{% if block.family %}{{block.family}}&#013;{% endif %}{% endfor %}">Multiple ({{analysis.detections|length}})</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% if config.moloch %}
                            <td>
                                {% if analysis.moloch_url %}
                                    <a href={{analysis.moloch_url}} target="_blank" class="badge bg-primary">MOLOCH</a>
                                {% else %}
                                      <span class="text-white-50 small">-</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            {% if analysis.category == "url" %}
                                {% if config.display_browser_martians %}
                                     <td>
                                         <span class="small">
                                         {% if analysis.mlist_cnt %}
                                             <span class="badge bg-warning">{{analysis.mlist_cnt}}</span>
                                         {% else %}
                                             <span class="text-white-50">-</span>
                                         {% endif %}
                                        </span>
                                    </td>
                                {% endif %}
                            {% else %}
                                {% if config.display_office_martians %}
                                    <td>
                                        <span class="small">
                                        {% if analysis.f_mlist_cnt %}
                                            <span class="badge bg-warning">{{analysis.f_mlist_cnt}}</span>
                                        {% else %}
                                            <span class="text-white-50">-</span>
                                        {% endif %}
                                        </span>
                                    </td>
                                {% endif %}
                            {% endif %}
                            {% if config.suricata %}
                            <td>
                                <span class="small">
                                {% if analysis.suri_alert_cnt %}
                                <a href="{% url "surialert" analysis.id %}" target="_blank" class="text-danger font-weight-bold">{{analysis.suri_alert_cnt}}</a><!--
                                {% else %}
                                <span class="text-white-50">-</span><!--
                                {% endif %}
                                --></span>
                            </td>
                            {% endif %}
                            {% if config.virustotal %}
                            <td>
                                {% if analysis.virustotal_summary %}
                                    <a href="{% url "antivirus" analysis.id %}" target="_blank" class="badge bg-dark">{{analysis.virustotal_summary}}</a>
                                {% else %}
                                      <span class="text-white-50 small">-</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            {% if config.malscore %}
                            <td>
                                {% if analysis.malscore != None %}
                                    <span class="badge {% if analysis.malscore <= 2.0 %}bg-success{% elif analysis.malscore <= 6.0 %}bg-warning{% else %}bg-danger{% endif %}"
                                    {% if analysis.detections %}title="{{analysis.detections}}"{% endif %}>
                                        {{analysis.malscore|floatformat:1}}
                                    </span>
                                {% else %}
                                    <span class="text-white-50 small">-</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            {% if config.expanded_dashboard %}
                            <td>
                                <span class="small">
                                {% if analysis.pcap_sha256 %}
                                <a href="{% url "file" "pcap" analysis.id analysis.pcap_sha256 %}" target="_blank" class="text-info"><i class="fas fa-download"></i></a>
                                {% else %}
                                <span class="text-white-50">-</span>
                                {% endif %}
                                </span>
                            </td>
                            {% if config.display_clamav %}
                                <td>
                                <span class="small">
                                {% if analysis.clamav %}
                                    {{analysis.clamav}}
                                {% else %}
                                    <span class="text-white-50">-</span>
                                {% endif %}
                                </span>
                                </td>
                            {% endif %}
                            {% endif %}
                            <td class="text-end">
                                {% if analysis.status == "pending" %}
                                    <span class="badge bg-dark">pending</span>
                                {% elif analysis.status == "running" %}
                                    <span class="badge bg-warning">running</span>
                                {% elif analysis.status == "completed" %}
                                    <span class="badge bg-info">processing</span>
                                {% elif analysis.status == "reported" %}
                                    {% if analysis.errors %}
                                        <span class="badge bg-danger">error</span>
                                    {% else %}
                                        <span class="badge bg-success">reported</span>
                                    {% endif%}
                                {% else %}
                                    <span class="badge bg-danger">{{analysis.status}}</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning text-center shadow-sm" role="alert">
            <i class="fas fa-search-minus fa-lg me-2"></i> <b>No results found.</b> Try refining your search query.
        </div>
    {% endif %}
{% else %}
    {% if error %}
        <div class="alert alert-danger text-center shadow-sm" role="alert">
            <i class="fas fa-exclamation-triangle fa-lg me-2"></i> <b>{{error}}</b>
        </div>
    {% endif %}
{% endif %}
{% endblock %}
