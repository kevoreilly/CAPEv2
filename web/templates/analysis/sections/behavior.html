<section id="behavior" class="mb-4">
    {% if results.behavior and results.behavior.anomaly %}
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header border-secondary">
                <h5 class="mb-0 text-white text-danger">Anomalies</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush text-dark">
                    {% for anomaly in results.behavior.anomaly %}
                    <li class="list-group-item bg-secondary text-white border-dark">
                        <span class="text-monospace font-weight-bold">{{anomaly.category}} {{anomaly.funcname}}</span>
                        {{anomaly.message}}
                        <small class="text-light">(pid={{anomaly.pid}}, process={{anomaly.name}})</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    {% if results.behavior and results.behavior.summary %}
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header border-secondary">
                <h5 class="mb-0 text-white">Behavior Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card bg-secondary text-white h-100">
                            <div class="card-header border-dark font-weight-bold">Mutexes</div>
                            <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                {% if results.behavior.summary.mutexes %}
                                    <ul class="list-unstyled mb-0">
                                        {% for mutex in results.behavior.summary.mutexes %}
                                        <li class="text-break">{{mutex}}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-secondary text-white h-100">
                            <div class="card-header border-dark font-weight-bold">Executed Commands</div>
                            <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                {% if results.behavior.summary.executed_commands %}
                                    <ul class="list-unstyled mb-0">
                                        {% for cmd in results.behavior.summary.executed_commands %}
                                        <li class="text-break">{{cmd}}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-secondary text-white h-100">
                            <div class="card-header border-dark font-weight-bold">Created Services</div>
                            <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                {% if results.behavior.summary["created_services"] %}
                                    <ul class="list-unstyled mb-0">
                                        {% for service in results.behavior.summary["created_services"] %}
                                        <li class="text-break">{{service}}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-secondary text-white h-100">
                            <div class="card-header border-dark font-weight-bold">Started Services</div>
                            <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                {% if results.behavior.summary["started_services"] %}
                                    <ul class="list-unstyled mb-0">
                                        {% for service in results.behavior.summary["started_services"] %}
                                        <li class="text-break">{{service}}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Summary Lists -->
                <div class="mt-3">
                    <button class="btn btn-outline-info btn-sm mb-2" type="button" data-toggle="collapse" data-target="#moreBehaviorSummary" aria-expanded="false" aria-controls="moreBehaviorSummary">
                        Show More Summary Details
                    </button>
                    <div class="collapse" id="moreBehaviorSummary">
                        <div class="row">
                            {% for key in ["files", "read_files", "write_files", "delete_files", "keys", "read_keys", "write_keys", "delete_keys", "resolved_apis"] %}
                            <div class="col-md-4 mb-3">
                                <div class="card bg-secondary text-white h-100">
                                    <div class="card-header border-dark font-weight-bold text-capitalize">{{ key|replace("_", " ") }}</div>
                                    <div class="card-body p-2" style="max-height: 150px; overflow-y: auto;">
                                        {% if results.behavior.summary[key] %}
                                            <ul class="list-unstyled mb-0 small">
                                                {% for item in results.behavior.summary[key] %}
                                                <li class="text-break">{{item}}</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    {% endif %}

    <div class="card bg-dark border-secondary mb-3">
        <div class="card-header border-secondary">
            <h5 class="mb-0 text-white">Processes</h5>
        </div>
        <div class="card-body">
            {% if summary_report %}
                {% if results.behavior and results.behavior.processes %}
                    <ul class="list-group list-group-flush text-dark">
                    {% for process in results.behavior.processes %}
                        <li class="list-group-item bg-secondary text-white border-dark">
                            <strong>{{process.process_name}}</strong>
                            <span class="badge badge-dark ml-2">PID: {{process.process_id}}</span>
                            <span class="badge badge-light ml-2">PPID: {{process.parent_id}}</span>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-muted">Nothing to display.</div>
                {% endif %}
            {% else %}
                <div class="mb-3">
                    <span class="badge badge-info">registry</span>
                    <span class="badge badge-secondary">filesystem</span>
                    <span class="badge badge-primary">process</span>
                    <span class="badge badge-success">network</span>
                    <!-- Add other badges as needed with distinct colors if possible -->
                </div>

                {% if results.behavior and results.behavior.processes %}
                    <div class="accordion" id="processesAccordion">
                    {% for process in results.behavior.processes %}
                        <div class="card bg-dark border-bottom border-secondary rounded-0">
                            <div class="card-header p-0" id="headingProc{{process.process_id}}">
                                <h2 class="mb-0">
                                    <button class="btn btn-block text-left p-3 text-white text-decoration-none shadow-none collapsed" type="button" data-toggle="collapse" data-target="#process_{{process.process_id}}" aria-expanded="false" aria-controls="process_{{process.process_id}}">
                                        <i class="fas fa-microchip mr-2"></i> {{process.process_name}}
                                        <small class="text-muted ml-2">PID: {{process.process_id}}, PPID: {{process.parent_id}}</small>
                                        {% if process.module_path %}<div class="small text-muted mt-1 ml-4">{{process.module_path}}</div>{% endif %}
                                    </button>
                                </h2>
                            </div>
                            <div id="process_{{process.process_id}}" class="collapse" aria-labelledby="headingProc{{process.process_id}}" data-parent="#processesAccordion">
                                <div class="card-body bg-secondary text-white p-0">
                                    {% if results.local_conf.apicalls %}
                                    <div class="table-responsive">
                                        <table class="table table-dark table-striped table-sm mb-0" style="table-layout: fixed;">
                                            <thead>
                                                <tr>
                                                    <th width="12%">Time</th>
                                                    <th width="8%">Thread</th>
                                                    <th width="20%">Function</th>
                                                    <th width="45%">Arguments</th>
                                                    <th width="8%">Status</th>
                                                    <th width="7%">Ret</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            {% for call in process.calls %}
                                            <tr class="{{call.category}}">
                                                <td>{{call.timestamp[11:]}}</td>
                                                <td>{{call.thread_id}}</td>
                                                <td class="text-break text-info font-weight-bold">{{call.api}}</td>
                                                <td class="text-break small">
                                                {% for argument in call.arguments %}
                                                    <div>
                                                        <span class="text-warning">{{argument.name}}</span>: 
                                                        <span class="text-light">{% if argument.pretty_value %}{{argument.pretty_value}}{% else %}{{argument.value}}{% endif %}</span>
                                                    </div>
                                                {% endfor %}
                                                </td>
                                                <td>
                                                    {% if call.status %}
                                                        <span class="badge badge-success">OK</span>
                                                    {% else %}
                                                        <span class="badge badge-danger">FAIL</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-break">{{call.return}}</td>
                                            </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="text-muted">Nothing to display.</div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</section>
