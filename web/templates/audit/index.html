{% extends "base.html" %}



{% block content %}

{% if messages %}
<div style="display: flex;">
    <ul class="messages">
        {% for message in messages %}
        <li class="alert alert-{{ message.tags }}">
            {{ message }}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<style>
    /* Force the body to be a flexbox container on this page only */
    body {
        display: flex !important;
        flex-direction: column !important;
        min-height: 100vh !important;
        margin: 0;
    }

    /* Target the main container that holds your content */
    /* If your base.html uses a <main> tag or a specific div ID, use that selector */
    main, .container, #content-wrapper {
        flex: 1 0 auto;
    }

    /* Pin the footer to the bottom */
    footer {
        flex-shrink: 0;
        margin-top: auto;
    }
</style>

<div class="row mb-4 justify-content-center ">
    <div class="col-lg-4">
        <div class="card bg-dark shadow-sm border-secondary">
            <ul class="nav nav-pills nav-fill bg-dark rounded shadow-sm p-1" id="testHarnessTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="audit-sessions-tab" data-bs-toggle="pill" href="#audit-sessions" role="tab"
                       aria-controls="audit-sessions" aria-selected="true">
                        <i class="fas fa-clipboard-list me-2"></i> Audit Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="available-tests-tab" data-bs-toggle="pill" href="#available-tests" role="tab"
                       aria-controls="available-tests" aria-selected="false">
                        <i class="fas fa-square-plus me-2"></i> New Audit Session
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="tab-content">
    <div class="tab-pane fade show active" id="audit-sessions" role="tabpanel" aria-labelledby="audit-sessions-tab">

        <div  class="col-lg-10" style="margin: 0 auto; padding: 0 3rem;">
            {% if paging.show_session_next == "show" or paging.show_session_prev == "show" %}
            <nav aria-label="Page navigation" class="mb-3">
                <ul class="pagination justify-content-center">
                    {% if paging.show_session_prev == "show" %}
                    <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "audit_index" %}page /{{paging.prev_page}}/">&larr; Newer</a></li>
                    {% endif %}
                    {% if paging.sessions_page_range %}
                    {% for page in paging.sessions_page_range %}
                    {% if page == paging.current_page %}
                    <li class="nav-item active"><a class="nav-link bg-danger border-danger text-white">{{page}}</a></li>
                    {% else %}
                    <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "audit_index" %}page /{{page}}/">{{page}}</a></li>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% if paging.show_session_next == "show" %}
                    <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "audit_index" %}page /{{paging.next_page}}/">Older &rarr;</a></li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}


            <div class="card shadow-sm border-0">
                <div class="card-header border-secondary bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-history me-2 text-white-50"></i> Recent Audit Sessions</h5>
                    <span class="badge bg-dark">{{total_sessions}} session{{total_sessions|pluralize}}</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Session ID</th>
                                <th>Created</th>
                                <th>Tests</th>
                                <th>Objectives</th>
                                <th class="text-end">Cleanup</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr>
                                <td>
                                    <a href="{% url 'test_session' session.id %}" class="text-white font-weight-bold"><i class="fas fa-link me-1"></i> #{{ session.id }}</a>
                                </td>


                                <td>
                                    <span class="d-flex flex-column">
                                        <span>{{ session.added_on|date:"Y-m-d" }}</span>
                                        <small class="text-muted">{{ session.added_on|date:"H:i" }}</small>
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex border border-dark rounded-1 overflow-hidden shadow-sm align-items-stretch"
                                         style="width: 320px; background-color: #1e1e1e; border-color: #333 !important; height: 38px;">

                                        <div class="flex-fill text-center py-1 border-end border-dark">
                                            <div class="text-uppercase fw-bold mb-0 {% if session.stats.tests.unqueued > 0 %}text-light{% else %}text-muted opacity-25{% endif %}"
                                                 style="font-size: 0.55rem; letter-spacing: 0.05rem;">Unqueued</div>
                                            <div class="small fw-bold {% if session.stats.tests.unqueued > 0 %}text-light{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.tests.unqueued }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark">
                                            <div class="text-uppercase fw-bold mb-0 {% if session.stats.tests.queued > 0 %}text-white-50{% else %}text-muted opacity-25{% endif %}"
                                                 style="font-size: 0.55rem; letter-spacing: 0.05rem;">Queued</div>
                                            <div class="small fw-bold {% if session.stats.tests.queued > 0 %}text-white-50{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.tests.queued }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.tests.running > 0 %}bg-info bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.tests.running > 0 %}text-info{% else %}text-muted opacity-25{% endif %} text-uppercase fw-bold mb-0"
                                                 style="font-size: 0.55rem; letter-spacing: 0.05rem;">Running</div>
                                            <div class="small fw-bold {% if session.stats.tests.running > 0 %}text-info{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.tests.running }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.tests.complete > 0 %}bg-success bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.tests.complete > 0 %}text-success{% else %}text-muted opacity-25{% endif %} text-uppercase fw-bold mb-0"
                                                 style="font-size: 0.55rem; letter-spacing: 0.05rem;">Done</div>
                                            <div class="small fw-bold {% if session.stats.tests.complete > 0 %}text-success{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.tests.complete }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 {% if session.stats.tests.failed > 0 %}bg-danger bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.tests.failed > 0 %}text-danger{% else %}text-muted opacity-25{% endif %} text-uppercase fw-bold mb-0"
                                                 style="font-size: 0.55rem; letter-spacing: 0.05rem;">Error</div>
                                            <div class="small fw-bold {% if session.stats.tests.failed > 0 %}text-danger{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.tests.failed }}
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <td>
                                    <div class="d-flex border border-dark rounded-1 overflow-hidden shadow-sm align-items-stretch"
                                         style="width: 400px; background-color: #1e1e1e; border-color: #333 !important; height: 38px;">

                                        <div class="flex-fill text-center py-1 border-end border-dark">
                                            <div class="{% if session.stats.objectives.untested > 0 %}text-light{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Untested</div>
                                            <div class="small fw-bold {% if session.stats.objectives.untested > 0 %}text-light{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.untested }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.objectives.skipped > 0 %}bg-light bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.objectives.skipped > 0 %}text-light{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Skipped</div>
                                            <div class="small fw-bold {% if session.stats.objectives.skipped > 0 %}text-light{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.skipped }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.objectives.error > 0 %}bg-danger bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.objectives.error > 0 %}text-danger{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Error</div>
                                            <div class="small fw-bold {% if session.stats.objectives.error > 0 %}text-danger{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.error }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.objectives.info > 0 %}bg-info bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.objectives.info > 0 %}text-info{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Info</div>
                                            <div class="small fw-bold {% if session.stats.objectives.info > 0 %}text-info{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.info }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 border-end border-dark {% if session.stats.objectives.success > 0 %}bg-success bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.objectives.success > 0 %}text-success{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Success</div>
                                            <div class="small fw-bold {% if session.stats.objectives.success > 0 %}text-success{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.success }}
                                            </div>
                                        </div>

                                        <div class="flex-fill text-center py-1 {% if session.stats.objectives.failure > 0 %}bg-warning bg-opacity-10{% endif %}">
                                            <div class="{% if session.stats.objectives.failure > 0 %}text-warning{% else %}text-muted opacity-50{% endif %} text-uppercase fw-bold mb-0" style="font-size: 0.55rem; letter-spacing: 0.05rem;">Failure</div>
                                            <div class="small fw-bold {% if session.stats.objectives.failure > 0 %}text-warning{% else %}text-muted opacity-50{% endif %}">
                                                {{ session.stats.objectives.failure }}
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <td class="text-end">
                                    <form action="{% url 'delete_test_session' session.id %}" method="POST"
                                          onsubmit="return confirm('Are you sure you want to delete Session #{{ session.id }} and all its run data?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    No sessions found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <form action="{% url 'create_test_session' %}" method="POST">
        {% csrf_token %}
    </form>

    <div class="tab-pane fade" id="available-tests" role="tabpanel" aria-labelledby="available-tests-tab">
        <div class="col-lg-9" style="margin: 0 auto; padding: 0 3rem;">
            <div class="card shadow-sm border-0">
                <div class="card-header border-secondary bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-vial me-2 text-white-50"></i>New Audit Session: Available Tests</h5>
                    <span class="badge bg-dark">{{available_tests|length}} test{{ available_tests|pluralize }} </span>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2 mb-2 mx-sm-2 ">
                    
                    <div class="d-flex gap-2">
                        {% if available_tests %}
                        <button type="button" id="btnCreateSessionSelected"
                                onclick="createSession('selected')"
                                class="btn btn-outline-light px-3 shadow-sm" disabled>
                            <i class="fas fa-circle-check me-2"></i>New Session (Selected Tests) (<span id="selectedCount">0</span>)
                        </button>

                        <button type="button" id="btnCreateSessionAll" onclick="createSession('all')"
                                class="btn btn-outline-success px-3 shadow-sm me-2">
                            <i class="fas fa-circle-plus me-2"></i>New Session (All Tests)
                        </button>
                        {% endif %}
                    </div>

                    <form action="{% url 'reload_available_tests' %}" method="POST" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-info px-3 shadow-sm">
                            <i class="fas fa-sync me-2"></i>Reload Tests
                        </button>
                    </form>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="availableTestsTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                                <th>Name</th>
                                <th>Package</th>
                                <th>Targets</th>
                                <th>Description</th>
                                <th class="text-center">Config</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in available_tests %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_tests" value="{{ test.id }}" class="test-checkbox">
                                </td>
                                <td><strong>{{ test.name }}</strong></td>
                                <td><span class="badge badge-secondary">{{ test.package }}</span></td>
                                <td>
                                    {% if "windows" in test.targets|lower %}
                                    <i class="fab fa-windows text-info me-2" title="Windows"></i>
                                    {% endif %}

                                    {% if "linux" in test.targets|lower %}
                                    <i class="fab fa-linux text-dark" title="Linux"></i>
                                    {% endif %}

                                </td>
                                <td>
                                    <div class="text-muted small">{{ test.description }}</div>
                                    {% if test.payload_notes %}
                                    <div class="mt-1" title="Payload Notes">
                                        <i class="fas fa-file text-info me-1"></i>
                                        <small>{{ test.payload_notes }}</small>
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-link text-info"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#config-{{ test.id }}">
                                        <i class="fas fa-code"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="{{ colspan|default:6 }}" class="p-0 border-0">
                                    <div id="config-{{  test.id }}" class="collapse">
                                        <div class="py-3 bg-light">
                                            {% include "audit/partials/task_config.html" with test=test config_pretty=test.task_config_pretty colspan=5 %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ colspan|default:6 }}" class="text-center py-5 text-muted">
                                    <i class="fas fa-folder-open fa-3x mb-3 d-block"></i>
                                    No tests available. Place tests in the audits location and reload.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

        {% if paging.show_test_next == "show" or paging.show_test_prev == "show" %}
        {% endif %}
    </div>

<script>

        document.addEventListener("DOMContentLoaded", function () {
            // If the URL ends in #available-tests, find that tab and show it
            var hash = window.location.hash;
            if (hash) {
                var triggerEl = document.querySelector('a[href="' + hash + '"]');
                if (triggerEl) {
                    var tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const masterCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.test-checkbox');
            const btnSelected = document.getElementById('btnCreateSessionSelected');
            const countDisplay = document.getElementById('selectedCount');

            // Helper to update the button and counter
            function updateSelectedUI() {
                const checkedCount = document.querySelectorAll('.test-checkbox:checked').length;
                countDisplay.textContent = checkedCount;

                if (checkedCount === 0)
                {
                    btnSelected.disabled = true;
                    btnSelected.classList.remove('btn-success');
                    btnSelected.classList.add('btn-outline-light');
                }
                else
                {
                    btnSelected.disabled = false;
                    btnSelected.classList.remove('btn-outline-light');
                    btnSelected.classList.add('btn-success');
                }

                // Sync the master checkbox state
                masterCheckbox.checked = (checkedCount === checkboxes.length && checkboxes.length > 0);
                masterCheckbox.indeterminate = (checkedCount > 0 && checkedCount < checkboxes.length);
            }

            // Master checkbox listener
            masterCheckbox.addEventListener('change', function () {
                checkboxes.forEach(cb => {
                    cb.checked = masterCheckbox.checked;
                });
                updateSelectedUI();
            });

            // Individual checkbox listener
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectedUI);
            });
        });

        function createSession(mode) {
            let selectedIds = [];

            if (mode === 'all') {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox')).map(cb => cb.value);
            } else {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            }

            if (selectedIds.length === 0) return;

            // Create the form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'create_test_session' %}";

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'test_ids';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
    }



</script>

{% endblock %}
