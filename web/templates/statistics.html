{% extends "base.html" %}
{% block content %}
{% if statistics %}

<!-- Summary Card -->
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-chart-line me-2 text-info"></i>Statistics Overview</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h6 class="text-muted text-uppercase">Timeframe</h6>
                <h3 class="text-white">{{days}} <small class="text-muted">days</small></h3>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted text-uppercase">Total Tasks</h6>
                <h3 class="text-white">{{statistics.total}}</h3>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted text-uppercase">Average per Day</h6>
                <h3 class="text-white">{{statistics.average}}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Top Detections -->
{% if statistics.detections %}
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-bug me-2 text-danger"></i>Top Detections</h5>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-center align-items-center">
        {% for block in statistics.detections.items %}
            {% if block.family %}
            <a href="/analysis/search/detections:{{block.family}}" class="btn btn-outline-secondary m-2 d-flex align-items-center text-light" style="border-color: #444;">
                <span class="badge bg-danger me-2 p-2">{{block.total}}</span>
                <span class="font-weight-bold" style="font-size: 1rem;">{{block.family}}</span>
            </a>
            {% endif %}
        {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Top ASN -->
{% if statistics.asns %}
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-network-wired me-2 text-warning"></i>Top ASNs</h5>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-center align-items-center">
        {% for block in statistics.asns %}
            {% if block.asn %}
            <a href="/analysis/search/asn:{{block.asn}}" class="btn btn-outline-secondary m-2 d-flex align-items-center text-light" style="border-color: #444;">
                <span class="badge bg-warning me-2 p-2">{{block.total}}</span>
                <span class="font-weight-bold" style="font-size: 1rem;">{{block.asn}}</span>
            </a>
            {% endif %}
        {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Tasks per Day -->
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-calendar-alt me-2 text-success"></i>Tasks per Day</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-dark table-striped table-hover mb-0">
            <thead class="thead-dark">
              <tr>
                <th scope="col" class="border-top-0">Day</th>
                <th scope="col" class="border-top-0 text-end">Added</th>
                <th scope="col" class="border-top-0 text-end">Reported</th>
                <th scope="col" class="border-top-0 text-end">Failed</th>
              </tr>
            </thead>
            <tbody>
            {% for day, block in statistics.tasks.items %}
                <tr>
                    <th scope="row" class="text-light">{{day}}</th>
                    <td class="text-end"><span class="badge bg-secondary">{{block.added}}</span></td>
                    <td class="text-end"><span class="badge bg-success">{{block.reported}}</span></td>
                    <td class="text-end"><span class="badge bg-danger">{{block.failed}}</span></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Custom Stats -->
{% if statistics.custom_statistics %}
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-cogs me-2 text-primary"></i>Custom Signatures (Volatility/Static)</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-dark table-striped table-hover mb-0">
            <thead class="thead-dark">
              <tr>
                <th scope="col" class="border-top-0">Name</th>
                <th scope="col" class="border-top-0 text-end">Total Time (min)</th>
                <th scope="col" class="border-top-0 text-end">Runs</th>
                <th scope="col" class="border-top-0 text-end">Extracted</th>
                <th scope="col" class="border-top-0 text-end">Avg Time (min)</th>
              </tr>
            </thead>
            <tbody>
            {% for name, time in statistics.custom_statistics.items %}
                <tr>
                    <td>{{name}}</td>
                    <td class="text-end">{{time.total}}</td>
                    <td class="text-end">{{time.runs}}</td>
                    <td class="text-end">{{time.successful}}</td>
                    <td class="text-end">{{time.average}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Module Performance -->
<div class="row">
    {% if statistics.processing %}
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark shadow-sm border-secondary h-100">
            <div class="card-header border-secondary bg-transparent">
                <h5 class="mb-0 text-white"><i class="fas fa-microchip me-2 text-info"></i>Processing</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-sm table-striped table-hover mb-0">
                  <thead class="thead-dark">
                    <tr>
                      <th class="border-top-0">Name</th>
                      <th class="border-top-0 text-end">Total</th>
                      <th class="border-top-0 text-end">Runs</th>
                      <th class="border-top-0 text-end">Avg</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for name, time in statistics.processing.items %}
                      <tr>
                          <td class="text-truncate" style="max-width: 120px;" title="{{name}}">{{name}}</td>
                          <td class="text-end">{{time.total}}</td>
                          <td class="text-end">{{time.runs}}</td>
                          <td class="text-end">{{time.average}}</td>
                      </tr>
                  {% endfor %}
                  </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if statistics.signatures %}
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark shadow-sm border-secondary h-100">
            <div class="card-header border-secondary bg-transparent">
                <h5 class="mb-0 text-white"><i class="fas fa-file-signature me-2 text-warning"></i>Signatures</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-sm table-striped table-hover mb-0">
                  <thead class="thead-dark">
                    <tr>
                      <th class="border-top-0">Name</th>
                      <th class="border-top-0 text-end">Total</th>
                      <th class="border-top-0 text-end">Runs</th>
                      <th class="border-top-0 text-end">Avg</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for name, time in statistics.signatures.items %}
                      <tr>
                          <td class="text-truncate" style="max-width: 120px;" title="{{name}}">{{name}}</td>
                          <td class="text-end">{{time.total}}</td>
                          <td class="text-end">{{time.runs}}</td>
                          <td class="text-end">{{time.average}}</td>
                      </tr>
                  {% endfor %}
                  </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if statistics.reporting %}
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark shadow-sm border-secondary h-100">
            <div class="card-header border-secondary bg-transparent">
                <h5 class="mb-0 text-white"><i class="fas fa-file-alt me-2 text-success"></i>Reporting</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-sm table-striped table-hover mb-0">
                  <thead class="thead-dark">
                    <tr>
                      <th class="border-top-0">Name</th>
                      <th class="border-top-0 text-end">Total</th>
                      <th class="border-top-0 text-end">Runs</th>
                      <th class="border-top-0 text-end">Avg</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for name, time in statistics.reporting.items %}
                      <tr>
                          <td class="text-truncate" style="max-width: 120px;" title="{{name}}">{{name}}</td>
                          <td class="text-end">{{time.total}}</td>
                          <td class="text-end">{{time.runs}}</td>
                          <td class="text-end">{{time.average}}</td>
                      </tr>
                  {% endfor %}
                  </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% else %}
    <div class="alert alert-info text-center shadow-sm">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <p>No statistics found.</p>
    </div>
{% endif %}

<!-- Cluster Details -->
{% if statistics.distributed_tasks %}
<div class="card bg-dark shadow-sm border-secondary mb-4">
    <div class="card-header border-secondary bg-transparent">
        <h5 class="mb-0 text-white"><i class="fas fa-server me-2 text-primary"></i>Cluster Details</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for day, block in statistics.distributed_tasks.items %}
            <div class="col-md-3 mb-3">
                <div class="card bg-secondary text-white h-100 border-0">
                    <div class="card-header font-weight-bold">{{day}}</div>
                    <ul class="list-group list-group-flush text-dark">
                        {% for name, tasks in block.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{name}}
                            <span class="badge bg-primary badge-pill">{{tasks}}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
