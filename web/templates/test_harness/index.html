{% extends "base.html" %}



{% block content %}

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li class="alert alert-{{ message.tags }}">
        {{ message }}
    </li>
    {% endfor %}
</ul>
{% endif %}

<style>
    /* Force the body to be a flexbox container on this page only */
    body {
        display: flex !important;
        flex-direction: column !important;
        min-height: 100vh !important;
        margin: 0;
    }

    /* Target the main container that holds your content */
    /* If your base.html uses a <main> tag or a specific div ID, use that selector */
    main, .container, #content-wrapper {
        flex: 1 0 auto;
    }

    /* Pin the footer to the bottom */
    footer {
        flex-shrink: 0;
        margin-top: auto;
    }
</style>

<div class="row mb-4 justify-content-center ">
    <div class="col-lg-8">
        <div class="card bg-dark shadow-sm border-secondary">
            <ul class="nav nav-pills nav-fill bg-dark rounded shadow-sm p-1" id="testHarnessTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="test-sessions-tab" data-bs-toggle="pill" href="#test-sessions"
                       role="tab" aria-controls="files" aria-selected="true">
                        <i class="fas fa-file me-2"></i> Test Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="available-tests-tab" data-bs-toggle="pill" href="#available-tests" role="tab"
                       aria-controls="static" aria-selected="false">
                        <i class="fas fa-code me-2"></i> New Audit Session
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="tab-content">
    <div class="tab-pane fade show active" id="test-sessions" role="tabpanel" aria-labelledby="test-sessions-tab">

        {% if paging.show_session_next == "show" or paging.show_session_prev == "show" %}
        <nav aria-label="Page navigation" class="mb-3">
            <ul class="pagination justify-content-center">
                {% if paging.show_session_prev == "show" %}
                <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "test_harness" %}page/{{paging.prev_page}}/">&larr; Newer</a></li>
                {% endif %}
                {% if paging.sessions_page_range %}
                {% for page in paging.sessions_page_range %}
                {% if page == paging.current_page %}
                <li class="nav-item active"><a class="nav-link bg-danger border-danger text-white">{{page}}</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "test_harness" %}page/{{page}}/">{{page}}</a></li>
                {% endif %}
                {% endfor %}
                {% endif %}
                {% if paging.show_session_next == "show" %}
                <li class="nav-item"><a class="nav-link bg-dark border-secondary text-white" href="{% url "test_harness" %}page/{{paging.next_page}}/">Older &rarr;</a></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}


        <div class="card shadow-sm border-0">
            <div class="card-header border-secondary bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white"><i class="fas fa-history me-2 text-white-50"></i> Recent Audit Sessions</h5>
                <span class="badge bg-dark">{{files|length}} items</span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 100px;">Action</th>
                            <th>Session ID</th>
                            <th>Created</th>
                            <th>Objectives</th>
                            <th>Status</th>
                            <th class="text-end">Cleanup</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in sessions %}
                        <tr>
                            <td>
                                <a href="{% url 'test_session' session.id %}" class="btn btn-sm btn-primary w-100 shadow-sm">
                                    <i class="fas fa-folder-open me-1"></i> Open
                                </a>
                            </td>

                            <td class="fw-bold">#{{ session.id }}</td>

                            <td>
                                <div class="d-flex flex-column">
                                    <span>{{ session.added_on|date:"Y-m-d" }}</span>
                                    <small class="text-muted">{{ session.added_on|date:"H:i" }}</small>
                                </div>
                            </td>

                            <td>
                                <span class="badge rounded-pill bg-light text-dark border">
                                    {{ session.runs|length }} Tests
                                </span>
                            </td>

                            <td>
                                {% if session.is_active %}
                                <span class="badge bg-success text-uppercase">Active</span>
                                {% else %}
                                <span class="badge bg-secondary text-uppercase">Archived</span>
                                {% endif %}
                            </td>

                            <td class="text-end">
                                <form action="{% url 'delete_test_session' session.id %}" method="POST"
                                      onsubmit="return confirm('Are you sure you want to delete Session #{{ session.id }} and all its run data?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                No sessions found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <form action="{% url 'create_test_session' %}" method="POST">
        {% csrf_token %}
    </form>
</div>


<div class="tab-content">
    <div class="tab-pane fade" id="available-tests" role="tabpanel" aria-labelledby="available-tests-tab">

        <nav aria-label="Page navigation" class="mb-3">
            <ul class="pagination justify-content-center">
                PAGING GOES HERE
            </ul>
        </nav>

        <div class="card shadow-sm border-0">
            <div class="card-header border-secondary bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white"><i class="fas fa-vial me-2 text-white-50"></i>New Audit Session: Available Tests</h5>
                <span class="badge bg-dark">{{files|length}} items</span>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2 mb-2 mx-sm-2 ">
                <div class="d-flex gap-2">
                    <button type="button" id="btnCreateSessionAll" onclick="createSession('all')"
                            class="btn btn-success px-3 shadow-sm me-2">
                        <i class="fas fa-play-circle me-2"></i>New Session (All)
                    </button>

                    <button type="button" id="btnCreateSessionSelected"
                            onclick="createSession('selected')"
                            class="btn btn-outline-success px-3 shadow-sm" disabled>
                        <i class="fas fa-check-double me-2"></i>New Session (Selected) (<span id="selectedCount">0</span>)
                    </button>
                </div>

                <form action="{% url 'reload_available_tests' %}" method="POST" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-info px-3 shadow-sm">
                        <i class="fas fa-sync me-2"></i>Reload Tests
                    </button>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="availableTestsTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                            <th>Name</th>
                            <th>Package</th>
                            <th>Targets</th>
                            <th>Description</th>
                            <th class="text-center">Config</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test in available_tests %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_tests" value="{{ test.id }}" class="test-checkbox">
                            </td>
                            <td><strong>{{ test.name }}</strong></td>
                            <td><span class="badge badge-secondary">{{ test.package }}</span></td>
                            <td>
                                {% if "windows" in test.targets|lower %}
                                <i class="fab fa-windows text-info me-2" title="Windows"></i>
                                {% endif %}

                                {% if "linux" in test.targets|lower %}
                                <i class="fab fa-linux text-dark" title="Linux"></i>
                                {% endif %}

                            </td>
                            <td>
                                <div class="text-muted small">{{ test.description }}</div>
                                {% if test.payload_notes %}
                                <div class="mt-1" title="Payload Notes">
                                    <i class="fas fa-file text-info me-1"></i>
                                    <small>{{ test.payload_notes }}</small>
                                </div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-link text-info"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#config-{{ test.id }}">
                                    <i class="fas fa-code"></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="{{ colspan|default:6 }}" class="p-0 border-0">
                                <div  id="config-{{  test.id }}" class="collapse">
                                    <div class="py-3 bg-light">
                                        {% include "test_harness/partials/task_config.html" with test=test config_pretty=test.task_config_pretty colspan=5 %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 d-block"></i>
                                No tests found in the database. Hit "Reload from Disk" to scan.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if paging.show_test_next == "show" or paging.show_test_prev == "show" %}
    {% endif %}
</div>

<script>
        document.addEventListener("DOMContentLoaded", function () {
            // If the URL ends in #available-tests, find that tab and show it
            var hash = window.location.hash;
            if (hash) {
                var triggerEl = document.querySelector('a[href="' + hash + '"]');
                if (triggerEl) {
                    var tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }
        });

        //this is reused in the session view later, so we store it globally in the window
        window.copyToClipboard = function copyToClipboard(text) {
            // Try the modern way first (requires HTTPS)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
            } else {
                // Fallback for HTTP: Create a hidden textarea, select it, and copy
                const textArea = document.createElement("textarea");
                textArea.value = text;

                // Ensure the textarea is out of the viewport
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);

                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback HTTP cliipboard copy failed', err);
                }

                document.body.removeChild(textArea);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const masterCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.test-checkbox');
            const btnSelected = document.getElementById('btnCreateSessionSelected');
            const countDisplay = document.getElementById('selectedCount');

            // Helper to update the button and counter
            function updateSelectedUI() {
                const checkedCount = document.querySelectorAll('.test-checkbox:checked').length;
                countDisplay.textContent = checkedCount;
                
                if (checkedCount === 0)
                {
                    btnSelected.disabled = true;
                    btnSelected.classList.remove('btn-outline-success');
                    btnSelected.classList.add('btn-outline-light');
                }
                else
                {
                    btnSelected.disabled = false;
                    btnSelected.classList.remove('btn-outline-light');
                    btnSelected.classList.add('btn-outline-success');
                }

                // Sync the master checkbox state
                masterCheckbox.checked = (checkedCount === checkboxes.length && checkboxes.length > 0);
                masterCheckbox.indeterminate = (checkedCount > 0 && checkedCount < checkboxes.length);
            }

            // Master checkbox listener
            masterCheckbox.addEventListener('change', function () {
                checkboxes.forEach(cb => {
                    cb.checked = masterCheckbox.checked;
                });
                updateSelectedUI();
            });

            // Individual checkbox listener
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectedUI);
            });
        });

        function createSession(mode) {
            let selectedIds = [];

            if (mode === 'all') {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox')).map(cb => cb.value);
            } else {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            }

            if (selectedIds.length === 0) return;

            // Create the form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'create_test_session' %}";

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'test_ids';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }
</script>

{% endblock %}
