{% extends "base.html" %}
{% block content %}


{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li class="alert alert-{{ message.tags }}">
        {{ message }}
    </li>
    {% endfor %}
</ul>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-pills nav-fill bg-dark rounded shadow-sm p-1" id="testHarnessTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active font-weight-bold" id="test-sessions-tab" data-bs-toggle="pill" href="#test-sessions"
                   role="tab" aria-controls="files" aria-selected="true">
                    <i class="fas fa-file me-2"></i> Test Sessions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="available-tests-tab" data-bs-toggle="pill" href="#available-tests" role="tab"
                   aria-controls="static" aria-selected="false">
                    <i class="fas fa-code me-2"></i> Available Tests
                </a>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="testSessions">
    <div class="tab-pane fade show active" id="test-sessions" role="tabpanel" aria-labelledby="test-sessions-tab">
        <div class="mt-5 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-history me-2 text-secondary"></i>Recent Test Sessions</h3>
            </div>

            <div class="card shadow-sm border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 100px;">Action</th>
                                <th>Session ID</th>
                                <th>Created</th>
                                <th>Objectives</th>
                                <th>Status</th>
                                <th class="text-end">Cleanup</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr>
                                <td>
                                    <a href="{% url 'test_session' session.id %}" class="btn btn-sm btn-primary w-100 shadow-sm">
                                        <i class="fas fa-folder-open me-1"></i> Open
                                    </a>
                                </td>

                                <td class="fw-bold">#{{ session.id }}</td>

                                <td>
                                    <div class="d-flex flex-column">
                                        <span>{{ session.added_on|date:"Y-m-d" }}</span>
                                        <small class="text-muted">{{ session.added_on|date:"H:i" }}</small>
                                    </div>
                                </td>

                                <td>
                                    <span class="badge rounded-pill bg-light text-dark border">
                                        {{ session.runs|length }} Tests
                                    </span>
                                </td>

                                <td>
                                    {% if session.is_active %}
                                    <span class="badge bg-success text-uppercase">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary text-uppercase">Archived</span>
                                    {% endif %}
                                </td>

                                <td class="text-end">
                                    <form action="{% url 'delete_test_session' session.id %}" method="POST"
                                          onsubmit="return confirm('Are you sure you want to delete Session #{{ session.id }} and all its run data?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    No sessions found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <form action="{% url 'create_test_session' %}" method="POST">
            {% csrf_token %}

        </form>
    </div>

    <div class="tab-pane fade" id="available-tests" role="tabpanel" aria-labelledby="available-tests-tab">
        <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
            <div class="d-flex gap-2">
                <button type="button" id="btnCreateSessionAll" onclick="createSession('all')"
                        class="btn btn-success px-4 shadow-sm me-2">
                    <i class="fas fa-play-circle me-2"></i>New Session (All)
                </button>

                <button type="button" id="btnCreateSessionSelected" 
                        onclick="createSession('selected')"
                        class="btn btn-outline-success px-4 shadow-sm" disabled>
                    <i class="fas fa-check-double me-2"></i>New Session (Selected) (<span id="selectedCount">0</span>)
                </button>
            </div>

            <form action="{% url 'reload_available_tests' %}" method="POST" class="m-0">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-info px-4 shadow-sm">
                    <i class="fas fa-sync me-2"></i>Reload Tests
                </button>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="availableTestsTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Package</th>
                        <th>Targets</th>
                        <th>Description</th>
                        <th class="text-center">Config</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in available_tests %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_tests" value="{{ test.id }}" class="test-checkbox">
                        </td>
                        <td><strong>{{ test.name }}</strong></td>
                        <td><span class="badge badge-secondary">{{ test.package }}</span></td>
                        <td>
                            {% if "windows" in test.targets|lower %}
                            <i class="fab fa-windows text-info me-2" title="Windows"></i>
                            {% endif %}

                            {% if "linux" in test.targets|lower %}
                            <i class="fab fa-linux text-dark" title="Linux"></i>
                            {% endif %}

                        </td>
                        <td>
                            <div class="text-muted small">{{ test.description }}</div>
                            {% if test.payload_notes %}
                            <div class="mt-1">
                                <i class="fas fa-file text-info me-1"></i>
                                <small>{{ test.payload_notes }}</small>
                            </div>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-link text-info"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#config-{{ test.id }}">
                                <i class="fas fa-code"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="config-{{ test.id }}" class="collapse">
                        <td colspan="5" class="py-3 bg-light">
                            <div class="container-fluid">
                                <div class="row justify-content-center">
                                    <div class="col-md-10">
                                        <div class="shadow-sm border rounded overflow-hidden">
                                            <div class="bg-secondary px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
                                                <span class="small text-muted font-monospace"><i class="fas fa-file-code me-2"></i>task_config.json</span>
                                                <button class="btn btn-sm btn-link text-muted p-0"
                                                        onclick="copyToClipboard('{{ test.task_config_pretty|escapejs }}')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>

                                            <div class="p-3" style="background-color: #1e1e1e; max-height: 400px; overflow-y: auto;">
                                                <pre class="m-0" style="border: none; background: transparent;"><code style="color: #dcdcdc; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; line-height: 1.5;">{{ test.task_config_pretty }}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fas fa-folder-open fa-3x mb-3 d-block"></i>
                            No tests found in the database. Hit "Reload from Disk" to scan.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if paging.show_test_next == "show" or paging.show_test_prev == "show" %}
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // If the URL ends in #available-tests, find that tab and show it
            var hash = window.location.hash;
            if (hash) {
                var triggerEl = document.querySelector('a[href="' + hash + '"]');
                if (triggerEl) {
                    var tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }
        });

        function copyToClipboard(text) {
            // Try the modern way first (requires HTTPS)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
            } else {
                // Fallback for HTTP: Create a hidden textarea, select it, and copy
                const textArea = document.createElement("textarea");
                textArea.value = text;

                // Ensure the textarea is out of the viewport
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);

                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback HTTP cliipboard copy failed', err);
                }

                document.body.removeChild(textArea);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const masterCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.test-checkbox');
            const btnSelected = document.getElementById('btnCreateSessionSelected');
            const countDisplay = document.getElementById('selectedCount');

            // Helper to update the button and counter
            function updateSelectedUI() {
                const checkedCount = document.querySelectorAll('.test-checkbox:checked').length;
                countDisplay.textContent = checkedCount;
                btnSelected.disabled = checkedCount === 0;

                // Sync the master checkbox state
                masterCheckbox.checked = (checkedCount === checkboxes.length && checkboxes.length > 0);
                masterCheckbox.indeterminate = (checkedCount > 0 && checkedCount < checkboxes.length);
            }

            // Master checkbox listener
            masterCheckbox.addEventListener('change', function () {
                checkboxes.forEach(cb => {
                    cb.checked = masterCheckbox.checked;
                });
                updateSelectedUI();
            });

            // Individual checkbox listener
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectedUI);
            });
        });

        function createSession(mode) {
            let selectedIds = [];

            if (mode === 'all') {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox')).map(cb => cb.value);
            } else {
                selectedIds = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            }

            if (selectedIds.length === 0) return;

            // Create the form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'create_test_session' %}";

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'test_ids';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }
    </script>


    {% endblock %}
